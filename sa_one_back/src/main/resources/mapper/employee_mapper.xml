<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.korit.sa_one_back.mapper.EmployeeMapper">

    <!-- ✅ storeId + userId가 ACTIVE 상태로 이미 등록돼있는지 체크 -->
    <select id="existsActiveEmployee" resultType="boolean">
        select exists(
        select 1
        from store_employee_tb
        where store_id = #{storeId}
        and user_id = #{userId}
        and work_status = 'ACTIVE'
        )
    </select>

    <!-- ✅ 직원 소속(store_employee) 추가 -->
    <insert id="insertStoreEmployee" useGeneratedKeys="true" keyProperty="storeEmployeeId">
        insert into store_employee_tb (
        store_employee_id,
        store_id,
        user_id,
        employee_no,
        employee_name,
        position_id,
        join_date,
        work_status,
        updated_at
        ) values (
        default,
        #{storeId},
        #{userId},
        #{employeeNo},
        null,
        #{positionId},
        #{joinDate},
        #{workStatus},
        now()
        )
    </insert>

    <!-- ✅ 직원 목록 조회 (as 없음)
         ⚠️ XML에서 '<=' 같은 기호는 CDATA로 감싸야 안전함 -->
    <select id="selectEmployees" resultType="com.korit.sa_one_back.dto.response.EmployeeListRespDto">
        <![CDATA[
        select
            se.store_employee_id,
            se.store_id,
            se.user_id,
            se.employee_no,
            se.position_id,
            se.join_date,
            se.work_status,

            u.name,
            u.email,
            u.phone,
            u.img_url,
            u.img_path,
            u.birth_date,

            p.position_name,

            pay.pay_type,
            pay.hourly_rate,
            pay.monthly_salary,
            pay.start_date,
            pay.end_date
        from store_employee_tb se
        join user_tb u on u.user_id = se.user_id
        left join position_tb p on p.position_id = se.position_id
        left join pay_tb pay
            on pay.store_employee_id = se.store_employee_id
           and pay.start_date <= #{today}
           and (pay.end_date is null or pay.end_date >= #{today})
        where se.store_id = #{storeId}
          and se.work_status = 'ACTIVE'
        order by se.store_employee_id desc
        ]]>
    </select>

    <!-- ✅ 요청 ids가 해당 store 소속인지 검증 -->
    <select id="countBelonging" resultType="int">
        select count(*)
        from store_employee_tb
        where store_id = #{storeId}
        and store_employee_id in
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <!-- ✅ 퇴사 처리: work_status 변경 -->
    <update id="updateWorkStatus">
        update store_employee_tb
        set
        work_status = #{workStatus},
        updated_at = now()
        where store_employee_id = #{storeEmployeeId}
    </update>

</mapper>
