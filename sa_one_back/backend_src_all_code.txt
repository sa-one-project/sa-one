

==================================================
FILE: src/main/java/CodeExtractor.java
==================================================

import java.io.BufferedWriter;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.Arrays;
import java.util.HashSet;
import java.util.Set;
import java.util.stream.Stream;

public class CodeExtractor {

    // 1. 추출할 대상 설정 (현재 폴더의 src)
    private static final String SRC_DIR_NAME = "src";
    private static final String OUTPUT_FILE = "backend_src_all_code.txt";

    // 2. 포함할 확장자 (백엔드 개발에 필요한 소스 코드)
    private static final Set<String> ALLOWED_EXTENSIONS = new HashSet<>(Arrays.asList(
            ".java",
            ".xml",
            ".yml",
            ".yaml",
            ".properties",
            ".sql",
            ".gradle",  // Gradle 프로젝트인 경우
            ".txt",
            ".md"
    ));

    // 3. 제외할 파일명
    private static final Set<String> IGNORE_FILES = new HashSet<>(Arrays.asList(
            "mvnw", "mvnw.cmd", ".DS_Store"
    ));

    private static int fileCount = 0;

    public static void main(String[] args) {
        Path rootPath = Paths.get(".").toAbsolutePath().normalize();
        Path srcPath = rootPath.resolve(SRC_DIR_NAME);
        File outputFile = new File(OUTPUT_FILE);

        // 기존 결과 파일이 있으면 삭제
        if (outputFile.exists()) {
            outputFile.delete();
        }

        System.out.println("--- 추출 시작 ---");

        try (BufferedWriter writer = new BufferedWriter(new FileWriter(outputFile, StandardCharsets.UTF_8))) {

            if (!Files.exists(srcPath)) {
                System.err.println("에러: " + SRC_DIR_NAME + " 폴더를 찾을 수 없습니다.");
                return;
            }

            // 재귀적으로 파일 탐색
            processDirectory(srcPath, srcPath, writer);

            System.out.println("\n" + "=".repeat(30));
            if (fileCount > 0) {
                System.out.println("✅ 완료! 총 " + fileCount + "개의 파일이 추출되었습니다.");
                System.out.println("결과 파일: " + OUTPUT_FILE);
            } else {
                System.out.println("⚠️ 추출된 파일이 없습니다. src 폴더 위치를 확인해주세요.");
            }
            System.out.println("=".repeat(30));

        } catch (IOException e) {
            System.err.println("실행 중 에러 발생: " + e.getMessage());
            e.printStackTrace();
        }
    }

    private static void processDirectory(Path currentDir, Path rootSrcPath, BufferedWriter writer) throws IOException {
        try (Stream<Path> stream = Files.list(currentDir)) {
            stream.forEach(path -> {
                try {
                    if (Files.isDirectory(path)) {
                        processDirectory(path, rootSrcPath, writer);
                    } else {
                        extractFile(path, rootSrcPath, writer);
                    }
                } catch (IOException e) {
                    System.err.println("파일 처리 중 에러: " + path + " - " + e.getMessage());
                }
            });
        }
    }

    private static void extractFile(Path filePath, Path rootSrcPath, BufferedWriter writer) throws IOException {
        String fileName = filePath.getFileName().toString();
        String ext = "";

        int i = fileName.lastIndexOf('.');
        if (i > 0) {
            ext = fileName.substring(i).toLowerCase();
        }

        if (ALLOWED_EXTENSIONS.contains(ext) && !IGNORE_FILES.contains(fileName)) {
            // 상대 경로 계산 (src/main/java/...)
            String relativePath = SRC_DIR_NAME + File.separator + rootSrcPath.relativize(filePath).toString();

            // 윈도우의 역슬래시를 슬래시로 통일 (가독성 위해)
            relativePath = relativePath.replace("\\", "/");

            System.out.println("추출 중: " + relativePath);

            // 파일 읽기
            String content = new String(Files.readAllBytes(filePath), StandardCharsets.UTF_8);

            // 포맷에 맞춰 쓰기
            writer.write("\n\n" + "=".repeat(50) + "\n");
            writer.write("FILE: " + relativePath + "\n");
            writer.write("=".repeat(50) + "\n\n");
            writer.write(content);

            fileCount++;
        }
    }
}

==================================================
FILE: src/main/java/com/korit/sa_one_back/config/SecurityConfig.java
==================================================

package com.korit.sa_one_back.config;

import com.korit.sa_one_back.filter.JwtAuthenticationFilter;
import com.korit.sa_one_back.security.JwtAuthenticationEntryPoint;
import com.korit.sa_one_back.security.OAuth2SuccessHandler;
import com.korit.sa_one_back.service.OAuth2UserService;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import java.util.List;

@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
public class SecurityConfig {

    private final JwtAuthenticationFilter jwtAuthenticationFilter; // IoC가 제어할 수 있는 객체
    private final JwtAuthenticationEntryPoint jwtAuthenticationEntryPoint;
    private final OAuth2UserService oAuth2UserService;
    private final OAuth2SuccessHandler oAuth2SuccessHandler;

    @Bean  // Security에서 꼭 세팅 필요
    public SecurityFilterChain FilterChain(HttpSecurity http) throws Exception{

        // CORS적용, 세션 비활성화, http기본 로그인 비활성화, form 로그인 비활성화, csrf 비활성화 -> csr이기때문

        // 모든 세팅들은 다 람다로 들어감

        // CrossOrigin 적용
        http.cors(cors -> cors.configurationSource(corsConfigurationSource()));

        // 세션 비활성화(무상태) 설정
        http.sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS));

        // http 기본 로그인 비활성화
        http.httpBasic(httpBasic -> httpBasic.disable());

        // form 로그인 비활성화
        http.formLogin(formLogin -> formLogin.disable());

        // csrf 비활성화 ->  CSRF = 로그인된 사용자의 권한을 악용해 몰래 요청을 보내게 만드는 공격.(워터마크)
        http.csrf(csrf -> csrf.disable());

        //
        /*
            EndPoint호출 -> https://openapi.naver.com/v1/nid/me 호출

         */

        http.oauth2Login(oauth2 -> oauth2.userInfoEndpoint(userInfo -> userInfo.userService(oAuth2UserService))
                .successHandler(oAuth2SuccessHandler));

        // 특정 필터(UsernamePasswordAuthenticationFilter) 전에 직접 만든 필터(jwtAuthenticationFilter) 추가
        http.addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);

        // 모든 요청(URL)에 대해 인증 없이 누구나 접근할 수 있도록 허용하는 설정
        http.authorizeHttpRequests(auth -> {
            // permission 전체 허용 -> 이 요청 url은 열어주라고 명령하는것
            auth.requestMatchers("/api/auth/**").permitAll();
            auth.requestMatchers("/v3/api-docs/**").permitAll();
            auth.requestMatchers("/swagger-ui/**").permitAll();
            auth.requestMatchers("/swagger-ui.html").permitAll();
            auth.requestMatchers("/doc").permitAll();
            auth.requestMatchers("/oauth2/**").permitAll();
            auth.requestMatchers("/login/**").permitAll();
            auth.requestMatchers("/image/**").permitAll();
            auth.requestMatchers("/api/account/**").permitAll();
            auth.anyRequest().authenticated();
        });

        http.exceptionHandling(exception -> exception.authenticationEntryPoint(jwtAuthenticationEntryPoint));

        return http.build(); // 예외처리 필요
    }

    @Bean
    //CorsConfigurationSource ->  reactive안붙은거 사용
    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration cors = new CorsConfiguration();
        // 5173, 5174 프론트앤드 URL 주소로 접속하는 사람들 다 허용
        cors.setAllowedOrigins(List.of("http://localhost:5173", "http://localhost:5174"));
        // 허용해주고 싶은 요청들만 CrossOrigin 풀어주기
//        cors.setAllowedMethods(List.of("GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"));
        cors.setAllowedMethods(List.of("*"));
        // 모든 Header 다 허용
        cors.setAllowedHeaders(List.of("*"));
        // 인증을 할 때 인증서 등의 쿠키 허용
        cors.setAllowCredentials(true);

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        //  /** : 모든 URL에 요청을 다 허용 -> 프론트앤드에서 서버로 요청을 날릴 수 있다.
        source.registerCorsConfiguration("/**", cors);
        return source;
    }

    @Bean
    public BCryptPasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

}


==================================================
FILE: src/main/java/com/korit/sa_one_back/config/SwaggerApiConfig.java
==================================================

package com.korit.sa_one_back.config;

import io.swagger.v3.oas.models.Components;
import io.swagger.v3.oas.models.OpenAPI;
import io.swagger.v3.oas.models.info.Info;
import io.swagger.v3.oas.models.security.SecurityRequirement;
import io.swagger.v3.oas.models.security.SecurityScheme;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class SwaggerApiConfig {

    @Bean
    public OpenAPI openAPIConfig() {
        OpenAPI openAPI = new OpenAPI();
        Info info = new Info();
        info.title("소셜 게시판 미니 프로젝트");
        info.version("1.0");
        info.description("소셜 게시판 미니 프로젝트");

        SecurityRequirement securityRequirement = new SecurityRequirement();
        securityRequirement.addList("Bearer Authentication");

        SecurityScheme securityScheme = new SecurityScheme();
        securityScheme.name("Bearer Authentication");
        securityScheme.type(SecurityScheme.Type.HTTP);
        securityScheme.scheme("bearer");
        securityScheme.bearerFormat("JWT");

        Components components = new Components();
        components.addSecuritySchemes("Bearer Authentication", securityScheme);

        return openAPI
                .info(info)
                .addSecurityItem(securityRequirement)
                .components(components);
    }
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/controller/AccountController.java
==================================================

package com.korit.sa_one_back.controller;

import com.korit.sa_one_back.dto.request.FindUsernameReqDto;
import com.korit.sa_one_back.dto.request.PasswordResetConfirmReqDto;
import com.korit.sa_one_back.dto.request.PasswordResetReqDto;
import com.korit.sa_one_back.service.PasswordResetService;
import com.korit.sa_one_back.service.UserService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.Map;

@RestController
@RequiredArgsConstructor
@RequestMapping("/api/account")
public class AccountController {

    private final UserService userService;
    private final PasswordResetService resetService;

    @PostMapping("/find-username")
    public ResponseEntity<?> findUsername(@RequestBody FindUsernameReqDto dto) {
        userService.findUsernameAndSendMail(dto);

        return ResponseEntity.ok(Map.of(
                "message", "입력하신 정보와 일치하는 계정이 있으면 이메일을 전송했습니다."
        ));
    }

    @PostMapping("/password/reset-request")
    public ResponseEntity<?> requestPasswordReset(@RequestBody PasswordResetReqDto dto) {
        resetService.requestPasswordReset(dto.getEmail());
        return ResponseEntity.ok().body("입력하신 정보와 일치하는 계정이 있으면 이메일을 전송했습니다.");
    }

    @PostMapping("/password/reset")
    public ResponseEntity<?> confirmPasswordReset(@RequestBody PasswordResetConfirmReqDto dto) {
        resetService.confirmPasswordReset(dto.getToken(),
                dto.getNewPassword(),
                dto.getNewPasswordConfirm());
        return ResponseEntity.ok().body("비밀번호를 변경하였습니다.");
    }

}


==================================================
FILE: src/main/java/com/korit/sa_one_back/controller/AdminController.java
==================================================

package com.korit.sa_one_back.controller;

public class AdminController {
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/controller/AuthController.java
==================================================

package com.korit.sa_one_back.controller;

import com.korit.sa_one_back.dto.request.OAuth2SignUpReqDto;
import com.korit.sa_one_back.dto.request.SignInReqDto;
import com.korit.sa_one_back.dto.request.SignUpReqDto;
import com.korit.sa_one_back.entity.UserEntity;
import com.korit.sa_one_back.jwt.JwtTokenProvider;
import com.korit.sa_one_back.mapper.UserMapper;
import com.korit.sa_one_back.security.PrincipalUser;
import com.korit.sa_one_back.service.UserService;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.HttpStatusCode;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.web.bind.annotation.*;

import java.util.Map;

@RestController
@RequestMapping("/api/auth")
@RequiredArgsConstructor
public class AuthController {

    private final UserService userService;
    private final JwtTokenProvider jwtTokenProvider;
    private final UserMapper userMapper;

    @PostMapping("/local/signup")
    public ResponseEntity<?> signUp(@RequestBody SignUpReqDto dto) {
        userService.createLocalUser(dto);
        // 가입 후 JWT 발급
        UserEntity user = userMapper.findUserByUsername(dto.getUsername());
        if (user != null) {
            String token = jwtTokenProvider.createToken(user);
            return ResponseEntity.ok().body(token);
        } else {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("회원가입 후 사용자 조회 실패");
        }
    }

    @PostMapping("/oauth2/signup")
    public ResponseEntity<?> oauth2SignUp(@RequestBody OAuth2SignUpReqDto dto,
                                          @AuthenticationPrincipal PrincipalUser principalUser) {
        // SecurityContext에 OAuth2 인증 정보 존재
        if (principalUser == null || principalUser.isRegistered()) {
            return ResponseEntity.badRequest().body("이미 가입된 사용자 또는 인증 정보 없음");
        }

        userService.createOauth2User(dto);

        // 가입 완료 후 DB에서 다시 조회
        var user = userMapper.findByOauth2IdAndProvider(dto.getOauth2Id(), dto.getProvider());
        String token = jwtTokenProvider.createToken(user);

        return ResponseEntity.ok().body(token);
    }

    @PostMapping("/local/signin")
    public ResponseEntity<?> signIn(@Valid @RequestBody SignInReqDto dto) {
        String accessToken = userService.signin(dto);
        return ResponseEntity.ok(Map.of("accessToken", accessToken));
    }

}


==================================================
FILE: src/main/java/com/korit/sa_one_back/controller/EmployeeController.java
==================================================

package com.korit.sa_one_back.controller;

import com.korit.sa_one_back.dto.request.CreateEmployeeReqDto;
import com.korit.sa_one_back.dto.request.DeleteEmployeeReqDto;
import com.korit.sa_one_back.dto.response.EmployeeListRespDto;
import com.korit.sa_one_back.security.PrincipalUser;
import com.korit.sa_one_back.service.EmployeeService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

/**
 * 직원 추가/조회/삭제(퇴사) 컨트롤러
 */
@RestController
@RequiredArgsConstructor
public class EmployeeController {

    private final EmployeeService employeeService;

    /**
     * 직원 등록 (사장)
     */
    @PostMapping("/store/{storeId}/employees")
    public ResponseEntity<?> createEmployee(
            @PathVariable Long storeId,
            @RequestBody CreateEmployeeReqDto dto,
            @AuthenticationPrincipal PrincipalUser principalUser
    ) {
        employeeService.createEmployee(storeId, principalUser.getUserId(), dto);
        return ResponseEntity.ok().build();
    }

    /**
     * 직원 목록 조회
     * - workplaceId를 storeId로 사용
     */
    @GetMapping("/workplaces/{workplaceId}/employees")
    public ResponseEntity<List<EmployeeListRespDto>> getEmployees(
            @PathVariable Long workplaceId,
            @AuthenticationPrincipal PrincipalUser principalUser
    ) {
        return ResponseEntity.ok(employeeService.getEmployees(workplaceId, principalUser.getUserId()));
    }

    /**
     * 직원 삭제(퇴사 처리) - 다중
     * DELETE /store/{storeId}/employees
     */
    @DeleteMapping("/store/{storeId}/employees")
    public ResponseEntity<?> deleteEmployees(
            @PathVariable Long storeId,
            @RequestBody DeleteEmployeeReqDto dto,
            @AuthenticationPrincipal PrincipalUser principalUser
    ) {
        employeeService.deleteEmployees(storeId, principalUser.getUserId(), dto);
        return ResponseEntity.ok()
                .body(Map.of(
                        "success", true,
                        "message", "직원삭제 완료"
                ));
    }
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/controller/PayrollController.java
==================================================

package com.korit.sa_one_back.controller;

import com.korit.sa_one_back.dto.response.PayrollIdRespDto;
import com.korit.sa_one_back.entity.payroll.PayrollDetailEntity;
import com.korit.sa_one_back.entity.payroll.PayrollEntity;
import com.korit.sa_one_back.security.PrincipalUser;
import com.korit.sa_one_back.service.payroll.PayrollService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequiredArgsConstructor
@RequestMapping("/api/payrolls")
public class PayrollController {

    private final PayrollService payrollService;

    @GetMapping("/me")
    public ResponseEntity<PayrollEntity> getMyPayroll(
            @AuthenticationPrincipal PrincipalUser principalUser,
            @RequestParam Long storeId,
            @RequestParam("ym") String payslipYearMonth
    ) {
        Long userId = principalUser.getUserId();
        return ResponseEntity.ok(payrollService.getMyPayroll(userId, storeId, payslipYearMonth));
    }

    @PostMapping("/me")
    public ResponseEntity<PayrollIdRespDto> generateMyPayroll(
            @AuthenticationPrincipal PrincipalUser principalUser,
            @RequestParam Long storeId,
            @RequestParam("ym") String payslipYearMonth
    ) {
        Long userId = principalUser.getUserId();
        Long payrollId = payrollService.generateMyPayroll(userId, storeId, payslipYearMonth);
        return ResponseEntity.ok(new PayrollIdRespDto(payrollId));
    }

    @GetMapping("/me/details")
    public ResponseEntity<List<PayrollDetailEntity>> getMyPayrollDetails(
            @AuthenticationPrincipal PrincipalUser principalUser,
            @RequestParam Long storeId,
            @RequestParam("ym") String payslipYearMonth
    ) {
        Long userId = principalUser.getUserId();
        return ResponseEntity.ok(payrollService.getMyPayrollDetails(userId, storeId, payslipYearMonth));
    }
}

==================================================
FILE: src/main/java/com/korit/sa_one_back/controller/StoreController.java
==================================================

package com.korit.sa_one_back.controller;

import com.korit.sa_one_back.dto.request.StoreApplicationReqDto;
import com.korit.sa_one_back.dto.response.MyStoreRespDto;
import com.korit.sa_one_back.entity.StoreApplicationEntity;
import com.korit.sa_one_back.entity.UserEntity;
import com.korit.sa_one_back.security.PrincipalUser;
import com.korit.sa_one_back.service.StoreApplicationService;
import lombok.RequiredArgsConstructor;
import org.apache.ibatis.annotations.Param;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/stores")
@RequiredArgsConstructor
public class StoreController {

    private final StoreApplicationService storeService;

    @PostMapping("")
    public void postStoreInformationByOwner(
            @RequestBody StoreApplicationReqDto dto,
            @AuthenticationPrincipal UserEntity user
    ) {
        storeService.postMyApplication(dto, user.getUserId());
    }

    @GetMapping("/my_application")
    public StoreApplicationEntity getMyApplication(@AuthenticationPrincipal UserEntity user) {
        return storeService.getMyApplication(user.getUserId());
    }

    @GetMapping("/me")
    public ResponseEntity<List<MyStoreRespDto>> getMyStores(@AuthenticationPrincipal PrincipalUser principalUser) {
        Long userId = principalUser.getUserId();;
        return ResponseEntity.ok(storeService.getMyStores(userId));
    }
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/controller/UserController.java
==================================================

package com.korit.sa_one_back.controller;

import com.korit.sa_one_back.dto.request.UpdateMyPageReqDto;
import com.korit.sa_one_back.dto.response.UserMeRespDto;
import com.korit.sa_one_back.entity.UserEntity;
import com.korit.sa_one_back.security.PrincipalUser;
import com.korit.sa_one_back.service.UserService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/users")
@RequiredArgsConstructor
public class UserController {

    private final UserService userService;

//    @GetMapping("/me")
//    public ResponseEntity<UserEntity> getMe(@AuthenticationPrincipal PrincipalUser principalUser) {
//
//        return ResponseEntity.ok(principalUser.getUser());
//    }
    @GetMapping("/me")
    public ResponseEntity<UserMeRespDto> getMyPage(
            Authentication authentication,
            @RequestParam(required = false) Long storeId
    ) {

        PrincipalUser principalUser = (PrincipalUser) authentication.getPrincipal();
        Long userId = principalUser.getUser().getUserId();
        UserMeRespDto resp = userService.getMyPage(userId, storeId);

        return ResponseEntity.ok(resp);
    }

    @PatchMapping("/me")
    public ResponseEntity<Void> updateMyPage(
            Authentication authentication,
            @RequestBody UpdateMyPageReqDto dto
    ) {
        PrincipalUser principalUser = (PrincipalUser) authentication.getPrincipal();
        Long userId = principalUser.getUser().getUserId();
        userService.updateMyPage(userId, dto);
        return ResponseEntity.ok().build();
    }

    @PostMapping("/delete/me")
    public ResponseEntity<?> deleteMe(@AuthenticationPrincipal PrincipalUser principalUser) throws IllegalAccessException {

        if (principalUser == null) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();
        }

        userService.delete(principalUser.getUserId());

        return ResponseEntity.ok().body("회원탈퇴 완료");
    }
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/dto/request/CreateEmployeeReqDto.java
==================================================

package com.korit.sa_one_back.dto.request;

import lombok.Data;

import java.time.LocalDate;
import java.time.LocalDateTime;

@Data
public class CreateEmployeeReqDto {
    // user_tb - 사용자 정보
    private String name;
    private LocalDate birthDate;
    private String address;
    private String email;
    private String phone;

    // user_tb 프로필 이미지
    private String imgUrl;
    private String imgPath;

    private String  employeeNo; // 사번 - store_employee_tb
    private LocalDate joinDate; // 입사일 - store_employee_tb
    private String positionName; // 고용형태 - position_tb

    // pay_tb
    private String payType; // 시급 또는 월급
    private int hourlyRate; // 시급
    private int monthlySalary; // 월급



}


==================================================
FILE: src/main/java/com/korit/sa_one_back/dto/request/DeleteEmployeeReqDto.java
==================================================

package com.korit.sa_one_back.dto.request;

import lombok.Data;

import java.util.List;

@Data
public class DeleteEmployeeReqDto {

    private List<Long> storeEmployeeId;

}


==================================================
FILE: src/main/java/com/korit/sa_one_back/dto/request/FindUsernameReqDto.java
==================================================

package com.korit.sa_one_back.dto.request;

import lombok.Data;

@Data
public class FindUsernameReqDto {
    private String name;
    private String email;
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/dto/request/OAuth2SignUpReqDto.java
==================================================

package com.korit.sa_one_back.dto.request;

import com.korit.sa_one_back.entity.UserEntity;
import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import lombok.Data;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.Date;

@Data
public class OAuth2SignUpReqDto {

    private int roleId;
    private String username;
    private String password;
    private String oauth2Id;
    private String provider;
    private String name;
    private String phone;
    @Email
    @NotBlank
    private String email;
    private String imgUrl;
    private String imgPath;

    private String tempToken;
    private String gender;
    private LocalDate birthDate;
    private boolean isDeleted;

    public UserEntity toOauth2Entity(String password) {
        return UserEntity.builder()
                .roleId(roleId)
                .username(provider + "_" + oauth2Id.substring(0, 12))
                .password(password)
                .name(name)
                .phone(phone)
                .email(email)
                .imgUrl(imgUrl)
                .imgPath(imgPath)
                .oauth2Id(oauth2Id)
                .provider(provider)
                .gender(gender)
                .birthDate(birthDate)
                .isDeleted(false)
                .build();
    }
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/dto/request/PasswordResetConfirmReqDto.java
==================================================

package com.korit.sa_one_back.dto.request;

import lombok.Data;

@Data
public class PasswordResetConfirmReqDto {
    private String token;
    private String newPassword;
    private String newPasswordConfirm;
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/dto/request/PasswordResetReqDto.java
==================================================

package com.korit.sa_one_back.dto.request;

import lombok.Data;

@Data
public class PasswordResetReqDto {
    private String email;
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/dto/request/payroll/PayrollDetailDto.java
==================================================

package com.korit.sa_one_back.dto.request.payroll;

import com.korit.sa_one_back.entity.payroll.PayrollDetailEntity;
import lombok.Builder;
import lombok.Data;

@Data
@Builder
public class PayrollDetailDto {
    private String itemCode;
    private int amount;

    private Integer minutes;
    private Double quantity;
    private Integer unitPrice;
    private Double multiplier;
    private String memo;

    public PayrollDetailEntity toEntity(Long payrollId, Long payrollItemId) {
        return PayrollDetailEntity.builder()
                .payrollId(payrollId)
                .payrollItemId(payrollItemId)
                .amount(amount)
                .minutes(minutes)
                .quantity(quantity)
                .unitPrice(unitPrice)
                .multiplier(multiplier)
                .memo(memo)
                .build();
    }
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/dto/request/payroll/PayrollDto.java
==================================================

package com.korit.sa_one_back.dto.request.payroll;

import com.korit.sa_one_back.entity.payroll.PayrollEntity;
import lombok.Builder;
import lombok.Data;

import java.time.LocalDate;
import java.time.LocalDateTime;

@Data
@Builder
public class PayrollDto {

    private Long storeEmployeeId;
    private String payslipYearMonth;

    private LocalDate periodStart;
    private LocalDate periodEnd;
    private LocalDate payDate; // nullable

    private String status; // "DRAFT" / "ISSUED" / "CONFIRMED"

    private boolean weeklyAllowanceYn;

    private double overtimeMultiplier;
    private double nightMultiplier;

    private int totalWorkMinutes;
    private int totalOvertimeMinutes;
    private int totalNightMinutes;

    private int grossPay;
    private int totalDeduction;
    private int netPay;

    private Double incomeTaxRate;
    private Double localTaxRate;
    private Double nationalPensionRate;
    private Double healthInsuranceRate;
    private Double employmentInsuranceRate;

    private int industrialAccidentInsurance;
    private LocalDateTime issuedAt;
    private LocalDateTime confirmedAt;

    public PayrollEntity toEntity() {
        return PayrollEntity.builder()
                .storeEmployeeId(storeEmployeeId)
                .payslipYearMonth(payslipYearMonth)
                .periodStart(periodStart)
                .periodEnd(periodEnd)
                .payDate(payDate)
                .status(status)

                .weeklyAllowanceYn(weeklyAllowanceYn)
                .overtimeMultiplier(overtimeMultiplier)
                .nightMultiplier(nightMultiplier)

                .totalWorkMinutes(totalWorkMinutes)
                .totalOvertimeMinutes(totalOvertimeMinutes)
                .totalNightMinutes(totalNightMinutes)

                .grossPay(grossPay)
                .totalDeduction(totalDeduction)
                .netPay(netPay)

                .incomeTaxRate(incomeTaxRate)
                .localTaxRate(localTaxRate)
                .nationalPensionRate(nationalPensionRate)
                .healthInsuranceRate(healthInsuranceRate)
                .employmentInsuranceRate(employmentInsuranceRate)

                .industrialAccidentInsurance(industrialAccidentInsurance)

                .issuedAt(issuedAt)
                .confirmedAt(confirmedAt)
                .build();
    }
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/dto/request/SignInReqDto.java
==================================================

package com.korit.sa_one_back.dto.request;

import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Pattern;
import lombok.Data;

@Data
public class SignInReqDto {


    @Pattern(regexp = "^[a-z0-9_-]{5,20}$",
            message = "아이디: 5~20자의 영문 소문자, 숫자와 특수기호(_),(-)만 사용 가능합니다.")
    private String username;
    @Pattern(regexp = "^(?=.*[A-Z])(?=.*[a-z])(?=.*\\d)(?=.*[^A-Za-z0-9])[A-Za-z0-9^A-Za-z0-9\\W]{8,16}$",
            message = "비밀번호: 8~16자의 영문 대/소문자, 숫자, 특수문자를 사용해 주세요.")
    private String password;

}


==================================================
FILE: src/main/java/com/korit/sa_one_back/dto/request/SignUpReqDto.java
==================================================

package com.korit.sa_one_back.dto.request;

import com.korit.sa_one_back.entity.UserEntity;
import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Pattern;
import lombok.Data;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;

import java.time.LocalDate;
import java.util.Date;

@Data
public class SignUpReqDto {

    private int roleId;
    @Pattern(regexp = "^[a-z0-9_-]{5,20}$",
            message = "아이디: 5~20자의 영문 소문자, 숫자와 특수기호(_),(-)만 사용 가능합니다.")
    private String username;
    @Pattern(regexp = "^(?=.*[A-Z])(?=.*[a-z])(?=.*\\d)(?=.*[^A-Za-z0-9])[A-Za-z0-9^A-Za-z0-9\\W]{8,16}$",
            message = "비밀번호: 8~16자의 영문 대/소문자, 숫자, 특수문자를 사용해 주세요.")
    private String password;
    private String name;
    private String phone;
    @Email
    @NotBlank
    private String email;
    private String imgUrl;
    private String imgPath;
    private String gender;
    private LocalDate birthDate;
    private boolean isDeleted;
    private String address;

    public UserEntity toLocalEntity(BCryptPasswordEncoder passwordEncoder) {
        return UserEntity.builder()
                .roleId(roleId)
                .username(username)
                .password(passwordEncoder.encode(password))
                .name(name)
                .phone(phone)
                .email(email)
                .imgUrl(imgUrl)
                .imgPath(imgPath)
                .oauth2Id(null)
                .provider(null)
                .gender(gender)
                .birthDate(birthDate)
                .isDeleted(false)
                .address(address)
                .build();
    }

}


==================================================
FILE: src/main/java/com/korit/sa_one_back/dto/request/StoreApplicationReqDto.java
==================================================

package com.korit.sa_one_back.dto.request;

import com.korit.sa_one_back.entity.StoreApplicationEntity;
import com.korit.sa_one_back.entity.StoreEntity;
import lombok.Data;

import java.time.LocalDateTime;

@Data
public class StoreApplicationReqDto {
    private Long storeId;
    private Long storeApplicationId;
    private String storeName;
    private String address;
    private String businessNumber;
    private String ownerName;
    private String storePhone;
    private String status;
    private String rejectReason;
    private LocalDateTime reviewedAt;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    private Long userId;

    public StoreApplicationEntity toStoreApplicationEntity(Long userId) {
        return StoreApplicationEntity.builder()
                .storeName(storeName)
                .address(address)
                .businessNumber(businessNumber)
                .ownerName(ownerName)
                .storePhone(storePhone)
                .userId(userId)
                .build();
    }

    public StoreEntity toStoreEntity() {
        return StoreEntity.builder()
                .storeName(storeName)
                .address(address)
                .businessNumber(businessNumber)
                .ownerName(ownerName)
                .storePhone(storePhone)
                .userId(userId)
                .build();
    }
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/dto/request/UpdateMyPageReqDto.java
==================================================

package com.korit.sa_one_back.dto.request;

import lombok.Data;

@Data
public class UpdateMyPageReqDto {

    private String email;
    private String phone;
    private String imgUrl;

}


==================================================
FILE: src/main/java/com/korit/sa_one_back/dto/response/EmployeeListRespDto.java
==================================================

package com.korit.sa_one_back.dto.response;

import lombok.Data;

import java.time.LocalDate;

@Data
public class EmployeeListRespDto {

    // store_employee_tb
    private Long storeEmployeeId;
    private Long storeId;
    private Long userId;
    private String employeeNo;
    private Long positionId;
    private LocalDate joinDate;
    private String workStatus;

    // user_tb
    private String name;
    private String email;
    private String phone;
    private String imgUrl;
    private String imgPath;
    private LocalDate birthDate;

    // position_tb
    private String positionName;

    // pay_tb
    private String payType;
    private Integer hourlyRate;
    private Integer monthlySalary;
    private LocalDate startDate;
    private LocalDate endDate;
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/dto/response/MyStoreRespDto.java
==================================================

package com.korit.sa_one_back.dto.response;

import com.korit.sa_one_back.entity.MyStoreEntity;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class MyStoreRespDto {
    private Long storeId;
    private String storeName;
    private String address;

    public static MyStoreRespDto fromEntity(MyStoreEntity entity) {
        return MyStoreRespDto.builder()
                .storeId(entity.getStoreId())
                .storeName(entity.getStoreName())
                .address(entity.getAddress())
                .build();
    }
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/dto/response/PayrollIdRespDto.java
==================================================

package com.korit.sa_one_back.dto.response;

import lombok.AllArgsConstructor;
import lombok.Data;

@Data
@AllArgsConstructor
public class PayrollIdRespDto {
    private Long payrollId;
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/dto/response/TokenRespDto.java
==================================================

package com.korit.sa_one_back.dto.response;

import com.korit.sa_one_back.entity.UserEntity;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class TokenRespDto {

    private String accessToken;
    private UserEntity user;
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/dto/response/UserMeRespDto.java
==================================================

package com.korit.sa_one_back.dto.response;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.Date;
import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class UserMeRespDto {

    // 공통 유저 정보
    private Long userId;
    private String role;
    private String username;

    private String email;
    private String phone;

    private String name;
    private String gender;
    private LocalDate birthDate;

    private String imgUrl;

    private EmployeeInfo employeeInfo;

    private OwnerInfo ownerInfo;


    @Data
    @Builder
    @NoArgsConstructor
    @AllArgsConstructor

    public static class EmployeeInfo {

        private Long storeEmployeeId;
        private String storeName;
        private String employeeNo;
        private Date joinDate;
        private String workState;
        private String payType;
        private int hourlyRate;
        private int monthlySalary;

    }

    @Data
    @Builder
    @NoArgsConstructor
    @AllArgsConstructor

    public static class OwnerInfo {

        private List<StoreInfo> storeList;
        private StoreInfo selectedStore;

    }

    @Data
    @Builder
    @NoArgsConstructor
    @AllArgsConstructor

    public static class StoreInfo {

        private Long storeId;
        private String storeName;
        private String businessNumber;
        private String storePhone;
        private String address;

        private String companyType;   // 특례사항
        private String industryName;  // 고용보험업종
        private String industryCode;  // 업종코드

    }

}



==================================================
FILE: src/main/java/com/korit/sa_one_back/entity/MyStoreEntity.java
==================================================

package com.korit.sa_one_back.entity;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class MyStoreEntity {
    private Long storeId;
    private String storeName;
    private String address;
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/entity/PayEntity.java
==================================================

package com.korit.sa_one_back.entity;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDate;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class PayEntity {

    private Long payId;
    private Long storeEmployeeId;
    private String payType;
    private Integer hourlyRate;
    private Integer monthlySalary;

    private LocalDate startDate;
    private LocalDate endDate;
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/entity/payroll/InsuranceRateEntity.java
==================================================

package com.korit.sa_one_back.entity.payroll;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class InsuranceRateEntity {
    private String insuranceCode;
    private int year;

    private double employeeRate;
    private double employerRate;
    private double totalRate;

    private String note;
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/entity/payroll/LimitEntity.java
==================================================

package com.korit.sa_one_back.entity.payroll;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class LimitEntity {
    private int year;
    private int lowerLimit;
    private int upperLimit;
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/entity/payroll/MonthlyAttendanceSummaryEntity.java
==================================================

package com.korit.sa_one_back.entity.payroll;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class MonthlyAttendanceSummaryEntity {
    private Long summaryId;
    private Long storeEmployeeId;
    private String payslipYearMonth;

    private int workDays;
    private int totalWorkMinutes;
    private int totalOvertimeMinutes;
    private int totalNightMinutes;

    private int lateCount;
    private int earlyLeaveCount;
    private int absentCount;
    private int leaveDays;

    private LocalDateTime createdAt;
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/entity/payroll/PayPolicyEntity.java
==================================================

package com.korit.sa_one_back.entity.payroll;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDate;
import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class PayPolicyEntity {
    private Long payPolicyId;
    private Long storeId;

    private LocalDate effectiveFrom;
    private LocalDate effectiveTo;
    private boolean active;

    private boolean weeklyAllowanceYn;
    private double overtimeMultiplier;
    private double nightMultiplier;

    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/entity/payroll/PayrollDetailEntity.java
==================================================

package com.korit.sa_one_back.entity.payroll;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class PayrollDetailEntity {
    private Long payrollDetailId;
    private Long payrollId;
    private Long payrollItemId;

    private int amount;

    private Integer minutes;
    private Double quantity;
    private Integer unitPrice;
    private Double multiplier;
    private String memo;
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/entity/payroll/PayrollEntity.java
==================================================

package com.korit.sa_one_back.entity.payroll;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDate;
import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class PayrollEntity {
    private Long payrollId;
    private Long storeEmployeeId;

    private String payslipYearMonth;
    private LocalDate periodStart;
    private LocalDate periodEnd;
    private LocalDate payDate;

    private String status;

    private boolean weeklyAllowanceYn;
    private double overtimeMultiplier;
    private double nightMultiplier;

    private int totalWorkMinutes;
    private int totalOvertimeMinutes;
    private int totalNightMinutes;

    private int grossPay;
    private int totalDeduction;
    private int netPay;

    private Double incomeTaxRate;
    private Double localTaxRate;
    private Double nationalPensionRate;
    private Double healthInsuranceRate;
    private Double employmentInsuranceRate;

    private int industrialAccidentInsurance;

    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    private LocalDateTime issuedAt;
    private LocalDateTime confirmedAt;
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/entity/payroll/StoreBusinessInfoEntity.java
==================================================

package com.korit.sa_one_back.entity.payroll;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class StoreBusinessInfoEntity {
    private Long storeId;
    private String companyType;
    private String industryCode;
}

==================================================
FILE: src/main/java/com/korit/sa_one_back/entity/payroll/TaxRateEntity.java
==================================================

package com.korit.sa_one_back.entity.payroll;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class TaxRateEntity {
    private int year;
    private double incomeTaxRate;
    private double localTaxRate;
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/entity/StoreApplicationEntity.java
==================================================

package com.korit.sa_one_back.entity;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class StoreApplicationEntity {
    private Long storeApplicationId;
    private String storeName;
    private String address;
    private String businessNumber;
    private String ownerName;
    private String storePhone;
    private String status;
    private String rejectReason;
    private LocalDateTime reviewedAt;
    private LocalDateTime createdAt;
    private Long userId;
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/entity/StoreEmployeeEntity.java
==================================================

package com.korit.sa_one_back.entity;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDate;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class StoreEmployeeEntity {
    private Long storeEmployeeId;

    private Long storeId;
    private Long userId;

    private String employeeNo;
    private Long positionId;
    private LocalDate joinDate;

    private String workStatus;
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/entity/StoreEntity.java
==================================================

package com.korit.sa_one_back.entity;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class StoreEntity {
    private Long storeId;
    private String storeName;
    private String address;
    private String businessNumber;
    private String ownerName;
    private String storePhone;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    private Long userId;
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/entity/UserEntity.java
==================================================

package com.korit.sa_one_back.entity;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.Date;


@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class UserEntity {
    private Long userId; // PK, NN, AI
    private String username; // NN, UQ
    private String password;
    private String oauth2Id;
    private String provider;
    private String name;
    private String phone; // UQ
    private String email;
    private String imgUrl;
    private String imgPath;
    private int roleId; // NN
    private LocalDateTime createdAt; // NN
    private LocalDateTime updatedAt; // NN
    private String gender;
    private LocalDate birthDate;
    private boolean isDeleted;
    private LocalDateTime deletedAt;
    private String address;
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/exception/GlobalExceptionHandler.java
==================================================

package com.korit.sa_one_back.exception;

import com.sun.net.httpserver.HttpsServer;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(StoreApplicationException.class)
    public ResponseEntity<?> handleNotFound(RuntimeException e) {
        return ResponseEntity.status(HttpStatus.NOT_FOUND)
                .body(e.getMessage());
    }
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/exception/StoreApplicationException.java
==================================================

package com.korit.sa_one_back.exception;

public class StoreApplicationException extends RuntimeException{
    public StoreApplicationException() {
        super("요청하신 신청 정보를 찾을 수 없습니다.");
    }
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/filter/JwtAuthenticationFilter.java
==================================================

package com.korit.sa_one_back.filter;

import com.korit.sa_one_back.entity.UserEntity;
import com.korit.sa_one_back.jwt.JwtTokenProvider;
import com.korit.sa_one_back.mapper.UserMapper;
import com.korit.sa_one_back.security.PrincipalUser;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.util.Map;

@Component
@RequiredArgsConstructor
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    private final JwtTokenProvider jwtTokenProvider;
    private final UserMapper userMapper;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {

        String bearerToken = request.getHeader("Authorization");
        // 토큰이 안들어왔거나 잘못된 토큰일 경우를 검사
        if (bearerToken == null || !bearerToken.startsWith("Bearer ")) {
            filterChain.doFilter(request, response);
            return;
        }
        System.out.println(bearerToken);
        // replaceAll -> Bearer 을 공백으로 바꿔줌 -> 제거
        String accessToken = bearerToken.replaceAll("Bearer ", "");

        if (!jwtTokenProvider.validateToken(accessToken)) {
            filterChain.doFilter(request, response);
            return;
        }

        // 토큰이 유효할 경우
        int userId = jwtTokenProvider.getUserId(accessToken);
        UserEntity foundUser = userMapper.findByUserId(userId);

        if (foundUser == null) {
            filterChain.doFilter(request, response);
            return;
        }

//        String role = foundUser.getRoleId() == 1 ? "ROLE_OWNER" : "ROLE_STAFF";

//        Collection<? extends GrantedAuthority> authorities = List.of(new SimpleGrantedAuthority(role));

        // oauth2Id null 방지
        String oauth2Id = foundUser.getOauth2Id() == null ? "" : foundUser.getOauth2Id();

        String provider = foundUser.getProvider() == null ? "" : foundUser.getProvider();
        String email = foundUser.getEmail() == null ? "" : foundUser.getEmail();
        String name = foundUser.getName() == null ? "" : foundUser.getName();

        PrincipalUser principalUser = new PrincipalUser(
                Map.of("id", oauth2Id),
                oauth2Id,
                provider,
                email,
                name,
                foundUser
        );

        UsernamePasswordAuthenticationToken authentication =
                new UsernamePasswordAuthenticationToken(principalUser, "", principalUser.getAuthorities());

        SecurityContextHolder.getContext().setAuthentication(authentication);
        // 필터 연결
        filterChain.doFilter(request, response);
    }

}
/*
    서버 -> 처음으로 사이트에 들어왔으면 회원가입 하기
    회원가입 -> 로그인할 정보를 제공하는 것
    요청을 날려야 함  -> 인증이 필요 없음 -> 필터를 타면 안됨.
    -> 이 필터는 인증이 필요할 때만 타는 필터
    permitAll() : 인가 -> 회원가입 URL이 있어야 통과시킴
    회원가입을 하면 DB에 데이터가 저장됨
    ->로그인
    -> ID, PW를 입력한 다음 이전에 알려준 정보와 일치하면(인증)
    -> 인증 요청을 날림
    -> 서버 측에서는 ID, PW 맞는지 확인한 다음에
    -> 응답으로 토큰을 발행해 줌
    -> 클라이언트는 토큰을 가지고 있고, 이 클라이언트의 토큰을 이후의 다른 요청에 사용
    -> 로그인할 때 인증이 되어있어야 하나? --> NO
    => 로그인 요청도 permitAll();
    --> 데이터를 요청할 경우 인가가 필요
    -> 인증 이후의 받은 토큰을 가지고 인가를 받아야 함.
    ->회원가입, 로그인 외의 나머지 다른 모든 요청들은 인가받아야함.
*/

==================================================
FILE: src/main/java/com/korit/sa_one_back/jwt/JwtTokenProvider.java
==================================================

package com.korit.sa_one_back.jwt;

import com.korit.sa_one_back.entity.UserEntity;
import io.jsonwebtoken.JwtException;
import io.jsonwebtoken.JwtParser;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import io.jsonwebtoken.security.Keys;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import javax.crypto.SecretKey;
import java.nio.charset.StandardCharsets;
import java.util.Date;

@Component
public class JwtTokenProvider {

    private final SecretKey key;

    public JwtTokenProvider(@Value("${jwt.secret}") String secret) {
        key = Keys.hmacShaKeyFor(secret.getBytes(StandardCharsets.UTF_8));
    }

    public String createToken(UserEntity userEntity) {

        Date now = new Date();

        long expiredTime = now.getTime() + (1000L * 60L * 60L * 24L);
        Date expiredDate = new Date(expiredTime);

        return Jwts.builder()
                .subject("server token")
                .issuer("wan03224")
                .issuedAt(new Date())
                .expiration(expiredDate)    // 필수
                .claim("userId", userEntity.getUserId())    // 필수
                .signWith(key, SignatureAlgorithm.HS256)    // 필수
                .compact();
        // 토큰이 만들어진다.
    }

    public boolean validateToken(String token) {
        try {
            JwtParser jwtParser = Jwts.parser()
                    .setSigningKey(key)
                    .build();
            jwtParser.parseClaimsJws(token);
            return true;
        } catch (JwtException e) {
            return false;
        }
    }

    public int getUserId(String token) {
        return (int) Jwts.parser()
                .setSigningKey(key)
                .build()
                .parseClaimsJws(token)
                .getPayload()
                .get("userId");
    }
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/mapper/admin/AdminDashboardMapper.java
==================================================

package com.korit.sa_one_back.mapper.admin;

import org.apache.ibatis.annotations.Mapper;

@Mapper
public interface AdminDashboardMapper {
    int countStoreApplicationsByStatus();

    int existMinimumWage(int year);
    int existTaxRate(int year);
    int existInsuranceRate(int year);
    int existNationalPensionRateLimit(int year);
    int existHealthInsuranceRateLimit(int year);
    int existEmploymentCompanyRate(int year);
    int existIndustrialAccidentRate(int year);
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/mapper/admin/AdminPolicyMapper.java
==================================================

package com.korit.sa_one_back.mapper.admin;

import org.apache.ibatis.annotations.Mapper;

@Mapper
public interface AdminPolicyMapper {

}


==================================================
FILE: src/main/java/com/korit/sa_one_back/mapper/EmployeeMapper.java
==================================================

package com.korit.sa_one_back.mapper;

import com.korit.sa_one_back.dto.response.EmployeeListRespDto;
import com.korit.sa_one_back.entity.StoreEmployeeEntity;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

import java.time.LocalDate;
import java.util.List;

@Mapper
public interface EmployeeMapper {
    boolean existsActiveEmployee(@Param("storeId") Long storeId,
                                 @Param("userId") Long userId);

    int insertStoreEmployee(StoreEmployeeEntity entity);

    List<EmployeeListRespDto> selectEmployees(@Param("storeId") Long storeId,
                                              @Param("today") LocalDate today);

    int countBelonging(@Param("storeId") Long storeId,
                       @Param("ids") List<Long> ids);

    int updateWorkStatus(@Param("storeEmployeeId") Long storeEmployeeId,
                         @Param("workStatus") String workStatus);
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/mapper/MyPageMapper.java
==================================================

package com.korit.sa_one_back.mapper;

import com.korit.sa_one_back.dto.response.UserMeRespDto;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

import java.util.List;

@Mapper
public interface MyPageMapper {

    // ===== 직원 전용 =====
    UserMeRespDto.EmployeeInfo findEmployeeInfoByUserId(Long userId);

    // ===== 사장/매니저 전용 =====
    List<UserMeRespDto.StoreInfo> findMyStoreList(Long userId);
    Long findFirstStoreId(Long userId);

    UserMeRespDto.StoreInfo findMyStoreDetail(@Param("userId") Long userId,
                                                  @Param("storeId") Long storeId);
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/mapper/PayMapper.java
==================================================

package com.korit.sa_one_back.mapper;

import com.korit.sa_one_back.entity.PayEntity;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

import java.time.LocalDate;

@Mapper
public interface PayMapper {
    int insertPay(PayEntity entity);

    int closeCurrentPayByEmployee(@Param("storeEmployeeId") Long storeEmployeeId,
                                  @Param("today") LocalDate today);
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/mapper/PayrollMapper.java
==================================================

package com.korit.sa_one_back.mapper;

import com.korit.sa_one_back.dto.request.payroll.*;
import com.korit.sa_one_back.entity.PayEntity;
import com.korit.sa_one_back.entity.payroll.*;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

import java.time.LocalDate;
import java.util.List;
import java.util.Map;

@Mapper
public interface PayrollMapper {
    Long findStoreEmployeePayrollByUserIdAndStoreId(
            @Param("userId") Long userId,
            @Param("storeId") Long storeId
    );

    PayrollEntity findPayrollByYm (
            @Param("storeEmployeeId") Long storeEmployeeId,
            @Param("payslipYearMonth") String payslipYearMonth
    );
    void insertPayroll(PayrollEntity entity);

    List<PayrollDetailEntity> findPayrollDetailsByPayrollId(Long payrollId);
    int insertPayrollDetails(List<PayrollDetailEntity> details);

    List<Map<String, Object>> findPayrollItemCodeIdList();
    Long findPayrollItemIdByCode (String itemCode);

    MonthlyAttendanceSummaryEntity findMonthlySummary (
            @Param("storeEmployeeId") Long storeEmployeeId,
            @Param("payslipYearMonth") String payslipYearMonth
    );

    PayEntity findEffectivePay (
            @Param("storeEmployeeId") Long storeEmployeeId,
            @Param("asOf") LocalDate asOf
    );

    PayPolicyEntity findEffectivePolicy (
            @Param("storeId") Long storeId,
            @Param("asOf") LocalDate asOf
    );

    Integer sumWeeklyAllowanceAmountInMonth (
            @Param("storeEmployeeId") Long storeEmployeeId,
            @Param("monthStart") LocalDate monthStart,
            @Param("monthEnd") LocalDate monthEnd
    );

    TaxRateEntity findTaxRate (int year);

    LimitEntity findNationalPensionLimit (int year);
    LimitEntity findHealthInsuranceLimit (int year);

    InsuranceRateEntity findInsuranceRate (
            @Param("insuranceCode") String insuranceCode,
            @Param("year") int year
    );

    StoreBusinessInfoEntity findStoreBusinessInfo (Long storeId);
}



==================================================
FILE: src/main/java/com/korit/sa_one_back/mapper/PositionMapper.java
==================================================

package com.korit.sa_one_back.mapper;

import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

@Mapper
public interface PositionMapper {
    Long findPositionIdByName(@Param("positionName") String positionName);
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/mapper/StoreMapper.java
==================================================

package com.korit.sa_one_back.mapper;

import com.korit.sa_one_back.entity.MyStoreEntity;
import com.korit.sa_one_back.entity.StoreApplicationEntity;
import com.korit.sa_one_back.entity.StoreEntity;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

import java.time.LocalDateTime;
import java.util.List;

@Mapper
public interface StoreMapper {

    int insertStoreApplication(StoreApplicationEntity entity);

    StoreApplicationEntity selectByUserId(Long userId);

    StoreApplicationEntity selectByApplicationIdForAdmin(Long storeApplicationId);

    int insertStore(StoreEntity store);

    int updateApplicationStatus(@Param("storeApplicationId") Long storeApplicationId,
                                @Param("status") String status,
                                @Param("reviewedAt") LocalDateTime reviewedAt,
                                @Param("rejectReason") String rejectReason);
  
    int countByStoreId(@Param("storeId") Long storeId);
    Long findOwnerUserId(@Param("storeId") Long storeId);

    List<MyStoreEntity> findMyStoresByUserId(Long userId);
}

==================================================
FILE: src/main/java/com/korit/sa_one_back/mapper/UserMapper.java
==================================================

package com.korit.sa_one_back.mapper;

import com.korit.sa_one_back.dto.request.CreateEmployeeReqDto;
import com.korit.sa_one_back.entity.UserEntity;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

@Mapper
public interface UserMapper {

    int insertLocalUser(UserEntity user);
    int insertOauth2User(UserEntity user);

    UserEntity findByUserId(long userId);
    UserEntity findUserByUsername(String username);
    UserEntity findByOauth2IdAndProvider(String provider, String oauth2Id);

    Long findUserIdByEmail(@Param("email") String email);
    String findRoleNameByUserId(Long userId);

    int updateMyPage(UserEntity user);

    int softDelete(long userId);
    int updateEmployeeProfile(
            @Param("userId") Long userId,
            @Param("dto") CreateEmployeeReqDto dto);

    String findUsernameByNameAndEmail(String name, String email);

    int updatePassword(@Param("userId") Long userId, @Param("password") String password);
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/SaOneBackApplication.java
==================================================

package com.korit.sa_one_back;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class SaOneBackApplication {

    public static void main(String[] args) {
        SpringApplication.run(SaOneBackApplication.class, args);
    }

}


==================================================
FILE: src/main/java/com/korit/sa_one_back/security/JwtAuthenticationEntryPoint.java
==================================================

package com.korit.sa_one_back.security;

import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.web.AuthenticationEntryPoint;
import org.springframework.stereotype.Component;

import java.io.IOException;

@Component
public class JwtAuthenticationEntryPoint implements AuthenticationEntryPoint {

    // 인증 예외 처리
    // 원래라면 에러가 터졌을 때 로그인창으로 보내는데, 404가 뜨면 404 그대로 주고 , 다른 에러면 401에러를 준다
    @Override
    public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException) throws IOException, ServletException {
        if (response.getStatus() == HttpServletResponse.SC_NOT_FOUND) {
            response.sendError(HttpServletResponse.SC_NOT_FOUND);
        } else {
            response.sendError(HttpServletResponse.SC_UNAUTHORIZED, "인증 실패");
        }
    }
}

==================================================
FILE: src/main/java/com/korit/sa_one_back/security/OAuth2SuccessHandler.java
==================================================

package com.korit.sa_one_back.security;

import com.korit.sa_one_back.entity.UserEntity;
import com.korit.sa_one_back.jwt.JwtTokenProvider;
import com.korit.sa_one_back.mapper.UserMapper;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.Authentication;
import org.springframework.security.web.authentication.AuthenticationSuccessHandler;
import org.springframework.stereotype.Component;

import java.io.IOException;
@Component
@RequiredArgsConstructor
public class OAuth2SuccessHandler implements AuthenticationSuccessHandler {

    private final JwtTokenProvider jwtTokenProvider;
    private final UserMapper userMapper;

    @Override
    public void onAuthenticationSuccess(HttpServletRequest request,
                                        HttpServletResponse response,
                                        Authentication authentication)
            throws IOException {

        PrincipalUser principal = (PrincipalUser) authentication.getPrincipal();

        // 이미 가입된 사용자
        if (principal.isRegistered()) {
            String token = jwtTokenProvider.createToken(principal.getUser());
            response.sendRedirect(
                    "http://localhost:5173/auth/login/oauth2?accessToken=" + token
            );
            return;
        }

        // 신규 OAuth2 사용자
        response.sendRedirect(
                "http://localhost:5173/auth/signup/oauth2"
        );
    }
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/security/PrincipalUser.java
==================================================

package com.korit.sa_one_back.security;

import com.korit.sa_one_back.entity.UserEntity;
import lombok.Getter;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.oauth2.core.user.DefaultOAuth2User;
import org.springframework.security.oauth2.core.user.OAuth2User;

import java.util.Collection;
import java.util.List;
import java.util.Map;

@Getter
public class PrincipalUser implements OAuth2User {

    private final Map<String, Object> attributes;
    private final Long userId;
    private final String oauth2Id;
    private final String provider;
    private final String email;
    private final String name;

    private final UserEntity user;

    public PrincipalUser(Map<String, Object> attributes,
                         String oauth2Id,
                         String provider,
                         String email,
                         String name,
                         UserEntity user) {

        this.attributes = attributes;
        this.userId = user != null ? user.getUserId() : null;
        this.oauth2Id = oauth2Id;
        this.provider = provider;
        this.email = email;
        this.name = name;
        this.user = user;
    }

    public boolean isRegistered() {
        return user != null;
    }

    @Override
    public Map<String, Object> getAttributes() {
        return attributes;
    }

    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        if (isRegistered()) {
            String role = user.getRoleId() == 1 ? "ROLE_OWNER" : "ROLE_STAFF";
            return java.util.List.of((GrantedAuthority) () -> role);
        }
        return java.util.List.of((GrantedAuthority) () -> "ROLE_GUEST");
    }

    @Override
    public String getName() {
        return oauth2Id != null ? oauth2Id : "";
    }
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/security/RoleResolver.java
==================================================

package com.korit.sa_one_back.security;

import org.springframework.stereotype.Component;

@Component
public class RoleResolver {

    public String resolveRoleName(long roleId) {
        if (roleId == 1) return "ROLE_MANAGER"; // 관리자
        if (roleId == 2) return "ROLE_OWNER"; // 사장
        if (roleId == 3) return "ROLE_STAFF"; // 직원
        return "ROLE_GUEST"; // 기본값 (예: role_id가 0이거나 비정상일 때)
    }
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/service/admin/AdminDashboardService.java
==================================================

package com.korit.sa_one_back.service.admin;

import com.korit.sa_one_back.mapper.admin.AdminDashboardMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.time.LocalDate;
import java.util.Collections;
import java.util.LinkedHashMap;
import java.util.Map;

@Service
@RequiredArgsConstructor
public class AdminDashboardService {

    private final AdminDashboardMapper adminDashboardMapper;

    public static final class PolicyKey {
        public static final String MINIMUM_WAGE = "MINIMUM_WAGE";
        public static final String TAX_RATE = "TAX_RATE";
        public static final String INSURANCE_RATE = "INSURANCE_RATE";
        public static final String NATIONAL_PENSION_LIMIT = "NATIONAL_PENSION_LIMIT";
        public static final String HEALTH_INSURANCE_LIMIT = "HEALTH_INSURANCE_LIMIT";
        public static final String EMPLOYMENT_COMPANY_RATE = "EMPLOYMENT_COMPANY_RATE";
        public static final String INDUSTRIAL_ACCIDENT_RATE = "INDUSTRIAL_ACCIDENT_RATE";
    }

    public int countPendingApplication() {
        return adminDashboardMapper.countStoreApplicationsByStatus();
    }

    public Map<String, Boolean> getPolicyAlertsIfDue() {
        int targetYear = LocalDate.now().getYear() + 1;

        LocalDate now = LocalDate.now();
        LocalDate dueStartDate = LocalDate.of(targetYear, 1, 1).minusMonths(1);

        if (now.isBefore(dueStartDate)) {
            return Collections.emptyMap();
        }

        Map<String, Boolean> statusMap = countPolicyAlert(targetYear);

        Map<String, Boolean> alerts = new LinkedHashMap<>();

        for (Map.Entry<String, Boolean> e : statusMap.entrySet()) {
            if (!e.getValue()) {
                alerts.put(e.getKey(), false);
            }
        }
        return alerts;
    }

    private Map<String, Boolean> countPolicyAlert(int year) {
        Map<String, Boolean> result = new LinkedHashMap<>();

        result.put(PolicyKey.MINIMUM_WAGE,
                adminDashboardMapper.existMinimumWage(year) == 1);

        result.put(PolicyKey.TAX_RATE,
                adminDashboardMapper.existTaxRate(year) == 1);

        result.put(PolicyKey.INSURANCE_RATE,
                adminDashboardMapper.existInsuranceRate(year) == 1);

        result.put(PolicyKey.NATIONAL_PENSION_LIMIT,
                adminDashboardMapper.existNationalPensionRateLimit(year) == 1);

        result.put(PolicyKey.HEALTH_INSURANCE_LIMIT,
                adminDashboardMapper.existHealthInsuranceRateLimit(year) == 1);

        result.put(PolicyKey.EMPLOYMENT_COMPANY_RATE,
                adminDashboardMapper.existEmploymentCompanyRate(year) == 1);

        result.put(PolicyKey.INDUSTRIAL_ACCIDENT_RATE,
                adminDashboardMapper.existIndustrialAccidentRate(year) == 1);

        return result;
    }

}


==================================================
FILE: src/main/java/com/korit/sa_one_back/service/EmployeeService.java
==================================================

package com.korit.sa_one_back.service;

import com.korit.sa_one_back.dto.request.CreateEmployeeReqDto;
import com.korit.sa_one_back.dto.request.DeleteEmployeeReqDto;
import com.korit.sa_one_back.dto.response.EmployeeListRespDto;
import com.korit.sa_one_back.entity.PayEntity;
import com.korit.sa_one_back.entity.StoreEmployeeEntity;
import com.korit.sa_one_back.entity.UserEntity;
import com.korit.sa_one_back.mapper.*;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDate;
import java.util.List;

/**
 * 직원 추가/조회/삭제(퇴사) 서비스
 */
@Service
@RequiredArgsConstructor
public class EmployeeService {

    private final StoreMapper storeMapper;
    private final UserMapper userMapper;
    private final EmployeeMapper employeeMapper;
    private final PayMapper payMapper;
    private final PositionMapper positionMapper;

    /**
     * 직원 등록 알고리즘
     * 1) store 존재 확인
     * 2) 사장 권한 확인 (store_tb.user_id == 로그인 userId)
     * 3) positionName -> positionId 조회
     * 4) email로 user 조회 -> 없으면 생성, 있으면 최신 정보 업데이트(선택)
     * 5) store_employee 중복(활성) 체크
     * 6) store_employee insert (work_status는 ACTIVE로 고정)
     * 7) pay insert (start_date는 joinDate로 고정, end_date는 null)
     */
    @Transactional
    public void createEmployee(Long storeId, Long ownerUserId, CreateEmployeeReqDto dto) {

        // 1) store 존재 확인
        if (storeMapper.countByStoreId(storeId) == 0) {
            throw new RuntimeException("WORKPLACE_NOT_FOUND");
        }

        // 2) 사장 권한 확인
        Long storeOwnerId = storeMapper.findOwnerUserId(storeId);
        if (storeOwnerId == null || !storeOwnerId.equals(ownerUserId)) {
            throw new RuntimeException("FORBIDDEN_OWNER_ONLY");
        }

        // 3) positionName -> positionId 변환 (DB 저장은 id로 해야 함)
        Long positionId = positionMapper.findPositionIdByName(dto.getPositionName());
        if (positionId == null) {
            throw new RuntimeException("POSITION_NOT_FOUND");
        }

        // 4) user 처리 (email 기준)
        Long employeeUserId = userMapper.findUserIdByEmail(dto.getEmail());

        if (employeeUserId == null) {
            // 신규 유저 생성
            UserEntity user = UserEntity.builder()
                    .username(dto.getEmail())
                    .password(null)
                    .name(dto.getName())
                    .phone(dto.getPhone())
                    .email(dto.getEmail())
                    .imgUrl(dto.getImgUrl())
                    .imgPath(dto.getImgPath())
                    .roleId(3) // EMPLOYEE
                    .birthDate(dto.getBirthDate())
                    .build();

            userMapper.insertLocalUser(user); // useGeneratedKeys로 userId 채움
            employeeUserId = user.getUserId();
        } else {
            // 기존 유저면 프로필 갱신(선택)
            userMapper.updateEmployeeProfile(employeeUserId, dto);
        }

        // 5) 중복 직원 체크 (storeId + userId, ACTIVE)
        if (employeeMapper.existsActiveEmployee(storeId, employeeUserId)) {
            throw new RuntimeException("DUPLICATE_EMPLOYEE");
        }

        // 6) store_employee insert
        StoreEmployeeEntity se = StoreEmployeeEntity.builder()
                .storeId(storeId)
                .userId(employeeUserId)
                .employeeNo(dto.getEmployeeNo())
                .positionId(positionId)
                .joinDate(dto.getJoinDate())
                .workStatus("ACTIVE") // 요청 DTO에서 안 받고, 서버에서 ACTIVE 고정
                .build();

        employeeMapper.insertStoreEmployee(se); // useGeneratedKeys로 storeEmployeeId 채움

        // 7) pay insert (초기 급여는 joinDate부터 적용)
        PayEntity pay = PayEntity.builder()
                .storeEmployeeId(se.getStoreEmployeeId())
                .payType(dto.getPayType())
                .hourlyRate(dto.getHourlyRate())
                .monthlySalary(dto.getMonthlySalary())
                .startDate(dto.getJoinDate())
                .endDate(null)
                .build();

        payMapper.insertPay(pay);
    }

    /**
     * 직원 목록 조회
     * - 여기서는 사장만 조회 가능으로 처리(정책에 맞게 변경 가능)
     */
    @Transactional(readOnly = true)
    public List<EmployeeListRespDto> getEmployees(Long storeId, Long requestUserId) {

        if (storeMapper.countByStoreId(storeId) == 0) {
            throw new RuntimeException("WORKPLACE_NOT_FOUND");
        }

        Long storeOwnerId = storeMapper.findOwnerUserId(storeId);
        if (storeOwnerId == null || !storeOwnerId.equals(requestUserId)) {
            throw new RuntimeException("FORBIDDEN_WORKPLACE_ACCESS");
        }

        return employeeMapper.selectEmployees(storeId, LocalDate.now());
    }

    /**
     * 직원 삭제(퇴사 처리)
     * - 물리삭제 X
     * - store_employee_tb.work_status = INACTIVE
     * - 현재 유효 pay_tb.end_date = 오늘로 종료
     */
    @Transactional
    public void deleteEmployees(Long storeId, Long ownerUserId, DeleteEmployeeReqDto dto) {

        Long storeOwnerId = storeMapper.findOwnerUserId(storeId);
        if (storeOwnerId == null || !storeOwnerId.equals(ownerUserId)) {
            throw new RuntimeException("FORBIDDEN_OWNER_ONLY");
        }

        if (dto.getStoreEmployeeId() == null || dto.getStoreEmployeeId().isEmpty()) {
            throw new RuntimeException("INVALID_REQUEST");
        }

        // 요청된 ids가 전부 이 store 소속인지 검증
        int belongCount = employeeMapper.countBelonging(storeId, dto.getStoreEmployeeId());
        if (belongCount != dto.getStoreEmployeeId().size()) {
            throw new RuntimeException("INVALID_REQUEST");
        }

        LocalDate today = LocalDate.now();

        for (Long storeEmployeeId : dto.getStoreEmployeeId()) {
            employeeMapper.updateWorkStatus(storeEmployeeId, "INACTIVE");
            payMapper.closeCurrentPayByEmployee(storeEmployeeId, today);
        }
    }
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/service/MailService.java
==================================================

package com.korit.sa_one_back.service;

import lombok.RequiredArgsConstructor;
import org.springframework.mail.SimpleMailMessage;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
public class MailService {
    private final JavaMailSender mailSender;

    public void sendMarkedUsername(String toEmail, String maskedUsername) {
        SimpleMailMessage msg = new SimpleMailMessage();
        msg.setTo(toEmail);
        msg.setSubject("[SA:ONE] 아이디 찾기 안내");
        msg.setText(
                "요청하신 아이디는 다음과 같습니다."
                + maskedUsername + "\n\n" +
                "본인이 요청하지 않으셨다면 무시하세요."
        );
        mailSender.send(msg);
    }

    public void sendPasswordResetMail(String toEmail, String resetLink) {
        SimpleMailMessage msg = new SimpleMailMessage();
        msg.setTo(toEmail);
        msg.setSubject("[SA:ONE] 비밀번호 재설정 안내");
        msg.setText(
                "비밀번호 재설정을 요청하셨습니다.\n\n" +
                "아래 링크에서 새 비밀번호를 설정해 주세요. \n" +
                "본 링크는 30분 후에 만료됩니다. \n" +
                resetLink + "\n\n" +
                "본인이 요청하지 않으셨다면 무시하세요."
        );
        mailSender.send(msg);
    }
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/service/OAuth2UserService.java
==================================================

package com.korit.sa_one_back.service;

import com.korit.sa_one_back.entity.UserEntity;
import com.korit.sa_one_back.mapper.UserMapper;
import com.korit.sa_one_back.security.PrincipalUser;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.oauth2.client.userinfo.DefaultOAuth2UserService;
import org.springframework.security.oauth2.client.userinfo.OAuth2UserRequest;
import org.springframework.security.oauth2.core.OAuth2AuthenticationException;
import org.springframework.security.oauth2.core.user.OAuth2User;
import org.springframework.stereotype.Service;

import java.util.Collection;
import java.util.LinkedHashMap;
import java.util.Map;

@Service
@RequiredArgsConstructor
public class OAuth2UserService extends DefaultOAuth2UserService {

//    @Override
//    public OAuth2User loadUser(OAuth2UserRequest userRequest)
//            throws OAuth2AuthenticationException {
//
//        OAuth2User oAuth2User = super.loadUser(userRequest);
//        String clientName = userRequest.getClientRegistration().getClientName();
//
//        Collection<? extends GrantedAuthority> authorities = oAuth2User.getAuthorities();
//        Map<String, Object> attributes = new LinkedHashMap<>();
//        String nameAttributeKey = null;
//        UserEntity user = null;
//
//        if ("NAVER".equalsIgnoreCase(clientName)) {
//            Map<String, Object> response =
//                    (Map<String, Object>) oAuth2User.getAttributes().get("response");
//
//            attributes.putAll(response);
//            nameAttributeKey = "id";
//
//            user = UserEntity.builder()
//                    .oauth2Id((String) response.get("id"))
//                    .name((String) response.get("name"))
//                    .email((String) response.get("email"))
//                    .provider(clientName)
//                    .imgUrl((String) response.get("profile_image"))
//                    .imgPath(null)
//                    .roleId(0) // 가입유형 미정
//                    .build();
//        }
//
//
//        return new PrincipalUser(authorities, attributes, nameAttributeKey, user);
//    }

    private final UserMapper userMapper;

    @Override
    public PrincipalUser loadUser(OAuth2UserRequest userRequest) throws OAuth2AuthenticationException {
        OAuth2User oauth2User = super.loadUser(userRequest);

        String provider = userRequest.getClientRegistration().getRegistrationId().toUpperCase();
        String oauth2Id = oauth2User.getAttribute("sub");
        String email = oauth2User.getAttribute("email");
        String name = oauth2User.getAttribute("name");

        UserEntity user = userMapper.findByOauth2IdAndProvider(provider, oauth2Id);

        return new PrincipalUser(
                oauth2User.getAttributes(),
                oauth2Id,
                provider,
                email,
                name,
                user // null 가능
        );
    }
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/service/PasswordResetService.java
==================================================

package com.korit.sa_one_back.service;

import com.korit.sa_one_back.mapper.UserMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.stereotype.Service;

import java.util.UUID;
import java.util.concurrent.TimeUnit;

@Service
@RequiredArgsConstructor
public class PasswordResetService {

    private final UserMapper userMapper;
    private final MailService mailService;
    private final BCryptPasswordEncoder passwordEncoder;

    private final StringRedisTemplate redisTemplate;
    private static final String prefix = "password-reset:";
    private static final long ttl_min = 30;

    @Value("${app.base-url}")
    private String baseUrl;

    public void save(String token, Long userId) {
        redisTemplate.opsForValue().set(
                prefix + token,
                userId.toString(),
                ttl_min,
                TimeUnit.MINUTES
        );
    }

    public Long getUserId(String token) {
        String value = redisTemplate.opsForValue().get(prefix + token);
        return value == null ? null : Long.valueOf(value);
    }

    public void delete(String token) {
        redisTemplate.delete(prefix + token);
    }

    public void requestPasswordReset(String email) {
        Long userId = userMapper.findUserIdByEmail(email);

        if (userId == null) {
            return;
        }

        String tempToken = UUID.randomUUID().toString().replace("-", "");

        save(tempToken, userId);

        String resetUrl = baseUrl + "/reset-password?token=" + tempToken;
        mailService.sendPasswordResetMail(email, resetUrl);
    }

    public void confirmPasswordReset(String token,
                                     String newPassword,
                                     String newPasswordConfirm) {
        if (token == null || token.isBlank()) {
            throw new IllegalArgumentException("토큰이 유효하지 않습니다.");
        }
        if (newPassword == null || newPassword.isBlank()) {
            throw new IllegalArgumentException("비밀번호를 입력해 주세요.");
        }
        if (!newPassword.equals(newPasswordConfirm)) {
            throw new IllegalArgumentException("비밀번호가 일치하지 않습니다.");
        }

        Long userId = getUserId(token);
        if (userId == null) {
            throw new IllegalArgumentException("유효하지 않거나 만료된 토큰입니다.");
        }

        String encodedPassword = passwordEncoder.encode(newPassword);

        int updated = userMapper.updatePassword(userId, encodedPassword);
        if (updated == 0) {
            throw new IllegalStateException("비밀번호 변경에 실패하였습니다.");
        }

        delete(token);
    }
}

==================================================
FILE: src/main/java/com/korit/sa_one_back/service/payroll/PayrollFunctions.java
==================================================

package com.korit.sa_one_back.service.payroll;

import com.korit.sa_one_back.dto.request.payroll.PayrollDetailDto;
import com.korit.sa_one_back.entity.payroll.InsuranceRateEntity;
import com.korit.sa_one_back.entity.payroll.LimitEntity;
import com.korit.sa_one_back.entity.payroll.PayrollDetailEntity;
import com.korit.sa_one_back.mapper.PayrollMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.time.YearMonth;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Service
@RequiredArgsConstructor
public class PayrollFunctions {

    private final PayrollMapper payrollMapper;

    public YearMonth parseYearMonth(String yyyyMm) {
        if (yyyyMm == null || yyyyMm.length() != 6) {
            throw new IllegalStateException("월별 급여명세서 형식은 yyyymm 이어야 합니다. :" + yyyyMm);
        }
        int year = Integer.parseInt(yyyyMm.substring(0, 4));
        int month = Integer.parseInt(yyyyMm.substring(4, 6));
        return YearMonth.of(year, month);
    }

    public int calcMinutesPay(int minutes, int hourlyRate) {
        BigDecimal perMinutes =
                BigDecimal.valueOf(hourlyRate)
                        .divide(BigDecimal.valueOf(60), 10, RoundingMode.HALF_UP);
        return perMinutes.multiply(BigDecimal.valueOf(minutes))
                .setScale(0, RoundingMode.HALF_UP)
                .intValue();
    }

    public int calcPremium(int premiumMinutes, int hourlyRate, double multiplier) {
        if (premiumMinutes <= 0) return 0;
        if (multiplier <= 1.0) return 0;

        BigDecimal extra = BigDecimal.valueOf(multiplier).subtract(BigDecimal.ONE);

        BigDecimal perMinute =
                BigDecimal.valueOf(hourlyRate)
                        .divide(BigDecimal.valueOf(60), 10, RoundingMode.HALF_UP);

        BigDecimal amount = perMinute
                .multiply(BigDecimal.valueOf(premiumMinutes))
                .multiply(extra);

        return amount.setScale(0, RoundingMode.HALF_UP).intValue();
    }

    public int calcRateAmount(int baseAmount, double rate) {
        if (rate <= 0) return 0;
        return BigDecimal
                .valueOf(baseAmount)
                .multiply(BigDecimal.valueOf(rate))
                .setScale(0, RoundingMode.HALF_UP)
                .intValue();
    }

    public int calcInsuranceWithLimit(int grossPay,
                                       LimitEntity limitEntity,
                                       InsuranceRateEntity rateEntity) {
        if (rateEntity == null) return 0;
        double rate = rateEntity.getEmployeeRate();
        if (rate <= 0) return 0;

        int base = grossPay;
        if (limitEntity != null) {
            base = Math.max(base, limitEntity.getLowerLimit());
            base = Math.min(base, limitEntity.getUpperLimit());
        }

        return calcRateAmount(base, rate);
    }

    public int calcInsuranceWithNoLimit(int grossPay, InsuranceRateEntity rateEntity) {
        if (rateEntity == null) return 0;
        double rate = rateEntity.getEmployeeRate();
        if (rate <= 0) return 0;
        return calcRateAmount(grossPay, rate);
    }

    public void addDetail(List<PayrollDetailEntity> details,
                          Long payrollId,
                          Map<String, Long> itemIdMap,
                          PayrollDetailDto dto) {
        Long itemId = itemIdMap.get(dto.getItemCode());

        if (itemId == null) {
            throw new IllegalStateException("payroll_item_id에 item_code가 없습니다." + dto.getItemCode());
        }

        details.add(dto.toEntity(payrollId, itemId));
    }

    public Double rateOrNull(InsuranceRateEntity entity) {
        if (entity == null) return null;
        double rate = entity.getEmployeeRate();
        return (rate <= 0) ? null : rate;
    }

    public Map<String, Long> loadPayrollItemIdMap() {
        List<Map<String, Object>> rows = payrollMapper.findPayrollItemCodeIdList();
        Map<String, Long> map = new HashMap<>();
        for (Map<String, Object> r : rows) {
            String code = (String) r.get("itemCode");
            Object idObj = r.get("payrollItemId");
            if (code == null || idObj == null) continue;
            map.put(code, ((Number) idObj).longValue());
        }
        return map;
    }
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/service/payroll/PayrollService.java
==================================================

package com.korit.sa_one_back.service.payroll;

import com.korit.sa_one_back.dto.request.payroll.PayrollDetailDto;
import com.korit.sa_one_back.dto.request.payroll.PayrollDto;
import com.korit.sa_one_back.entity.PayEntity;
import com.korit.sa_one_back.entity.payroll.*;
import com.korit.sa_one_back.mapper.PayrollMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDate;
import java.time.YearMonth;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

@Service
@RequiredArgsConstructor
public class PayrollService {

    private final PayrollMapper payrollMapper;
    private final PayrollFunctions payrollFunctions;

    @Transactional
    public Long generateMyPayroll(Long userId, Long storeId, String payslipYearMonth) {
        Long storeEmployeeId = storeEmployeeId(userId, storeId);
        return generatePayrollForEmployeeMonth(storeId, storeEmployeeId, payslipYearMonth);
    }

    public PayrollEntity getMyPayroll(Long userId, Long storeId, String payslipYearMonth) {
        Long storeEmployeeId = payrollMapper.findStoreEmployeePayrollByUserIdAndStoreId(userId, storeId);
        PayrollEntity payroll = payrollMapper.findPayrollByYm(storeEmployeeId, payslipYearMonth );
        if (payroll == null) {
            throw new IllegalStateException("급여 명세서가 없습니다. 날짜 :" + payslipYearMonth);
        }
        return payroll;
    }

    public List<PayrollDetailEntity> getMyPayrollDetails(Long userId, Long storeId, String payslipYearMonth) {
        PayrollEntity payroll = getMyPayroll(userId, storeId, payslipYearMonth);
        return payrollMapper.findPayrollDetailsByPayrollId(payroll.getPayrollId());
    }

    private Long storeEmployeeId(Long userId, Long storeId) {
        Long storeEmployeeId = payrollMapper.findStoreEmployeePayrollByUserIdAndStoreId(userId, storeId);
        if (storeEmployeeId == null) {
            throw new IllegalStateException("해당 매장의 직원이 아닙니다.");
        }
        return storeEmployeeId;
    }

    @Transactional
    public Long generatePayrollForEmployeeMonth(Long storeId,
                                                Long storeEmployeeId,
                                                String payslipYearMonth) {
        PayrollEntity existPayroll = payrollMapper.findPayrollByYm(storeEmployeeId, payslipYearMonth);
        if (existPayroll != null) return existPayroll.getPayrollId();

        YearMonth ym = YearMonth.parse(payslipYearMonth);
        LocalDate periodStart = ym.atDay(1);
        LocalDate periodEnd = ym.atEndOfMonth();
        LocalDate asOf = periodEnd;

        MonthlyAttendanceSummaryEntity monthlyEntity = payrollMapper.findMonthlySummary(storeEmployeeId, payslipYearMonth);
        if (monthlyEntity == null) {
            throw new IllegalStateException("월별 출퇴 요약 데이터가 없습니다. storeEmployeeId :"
            + storeEmployeeId + ", 급여명세서 년월 :" + payslipYearMonth);
        }

        PayEntity payEntity = payrollMapper.findEffectivePay(storeEmployeeId, asOf);
        if (payEntity == null) {
            throw new IllegalStateException("유효한 월급 데이터가 없습니다. storeEmployeeId : "
            + storeEmployeeId);
        }

        PayPolicyEntity policyEntity = payrollMapper.findEffectivePolicy(storeId, asOf);
        if (policyEntity == null) {
            throw new IllegalStateException("유효한 월급 정책 데이터가 없습니다. storeId: "
            + storeId);
        }

        Integer hourlyRate = payEntity.getHourlyRate();
        if (hourlyRate == null || hourlyRate <= 0) {
            throw new IllegalStateException("정해진 시급이 없습니다. payId :"
            + payEntity.getPayId() + ", hourlyRate : " + hourlyRate);
        }

        int weeklyAllowanceAmount = 0;
        if (policyEntity.isWeeklyAllowanceYn()) {
            Integer sum = payrollMapper.sumWeeklyAllowanceAmountInMonth(storeEmployeeId, periodStart, periodEnd);
            weeklyAllowanceAmount = (sum == null) ? 0 : sum;
        }

        int totalWorkMinutes = monthlyEntity.getTotalWorkMinutes();
        int totalOvertimeMinutes = monthlyEntity.getTotalOvertimeMinutes();
        int totalNightMinutes = monthlyEntity.getTotalNightMinutes();

        int basePay = payrollFunctions.calcMinutesPay(totalWorkMinutes, hourlyRate);

        double overtimeMultiplier = (policyEntity.getOvertimeMultiplier() <= 0) ? 1.50 : policyEntity.getOvertimeMultiplier();
        double nightMultiplier = (policyEntity.getNightMultiplier() <= 0) ? 1.50 : policyEntity.getNightMultiplier();

        int overtimePremium = payrollFunctions.calcPremium(totalOvertimeMinutes, hourlyRate, overtimeMultiplier);
        int nightPremium = payrollFunctions.calcPremium(totalNightMinutes, hourlyRate, nightMultiplier);

        int grossPay = basePay + weeklyAllowanceAmount + overtimePremium + nightPremium;

        int year = ym.getYear();

        TaxRateEntity taxRateEntity = payrollMapper.findTaxRate(year);
        LimitEntity pensionLimit = payrollMapper.findNationalPensionLimit(year);
        LimitEntity healthLimit = payrollMapper.findHealthInsuranceLimit(year);

        InsuranceRateEntity pensionRate = payrollMapper.findInsuranceRate("NATIONAL_PENSION", year);
        InsuranceRateEntity healthRate = payrollMapper.findInsuranceRate("HEALTH_INSURANCE", year);
        InsuranceRateEntity employmentRate = payrollMapper.findInsuranceRate("EMPLOYMENT_INSURANCE", year);
        InsuranceRateEntity accidentRate = payrollMapper.findInsuranceRate("ACCIDENT_INSURANCE", year);

        int incomeTax = payrollFunctions.calcRateAmount(grossPay, taxRateEntity.getIncomeTaxRate());
        int localTax = payrollFunctions.calcRateAmount(incomeTax, taxRateEntity.getLocalTaxRate());

        int nationalPension = payrollFunctions.calcInsuranceWithLimit(grossPay, pensionLimit, pensionRate);
        int healthInsurance = payrollFunctions.calcInsuranceWithLimit(grossPay, healthLimit, healthRate);
        int employmentInsurance = payrollFunctions.calcInsuranceWithNoLimit(grossPay, employmentRate);

        int totalDeduction = incomeTax + localTax + nationalPension + healthInsurance + employmentInsurance;
        int netPay = grossPay - totalDeduction;

        int industrialAccidentInsurance = payrollFunctions.calcInsuranceWithNoLimit(grossPay, accidentRate);

        PayrollDto dto = PayrollDto.builder()
                .storeEmployeeId(storeEmployeeId)
                .payslipYearMonth(payslipYearMonth)
                .periodStart(periodStart)
                .periodEnd(periodEnd)
                .payDate(null)
                .status("DRAFT")
                .weeklyAllowanceYn(policyEntity.isWeeklyAllowanceYn())
                .overtimeMultiplier(overtimeMultiplier)
                .nightMultiplier(nightMultiplier)

                .totalWorkMinutes(totalWorkMinutes)
                .totalOvertimeMinutes(totalOvertimeMinutes)
                .totalNightMinutes(totalNightMinutes)

                .grossPay(grossPay)
                .totalDeduction(totalDeduction)
                .netPay(netPay)

                .incomeTaxRate(taxRateEntity.getIncomeTaxRate())
                .localTaxRate(taxRateEntity.getLocalTaxRate())
                .nationalPensionRate(payrollFunctions.rateOrNull(pensionRate))
                .healthInsuranceRate(payrollFunctions.rateOrNull(healthRate))
                .employmentInsuranceRate(payrollFunctions.rateOrNull(employmentRate))
                .industrialAccidentInsurance(industrialAccidentInsurance)

                .build();

        PayrollEntity payroll = dto.toEntity();

        payrollMapper.insertPayroll(payroll);
        Long payrollId = payroll.getPayrollId();

        Map<String, Long> itemIdMap = payrollFunctions.loadPayrollItemIdMap();
        List<PayrollDetailEntity> details = new ArrayList<>();

        payrollFunctions
                .addDetail(details, payrollId, itemIdMap,
                        PayrollDetailDto.builder()
                                .itemCode("BASE")
                                .amount(basePay)
                                .minutes(totalWorkMinutes)
                                .unitPrice(hourlyRate)
                                .multiplier(1.0)
                                .memo("기본급")
                                .build());

        if (weeklyAllowanceAmount > 0) payrollFunctions
                .addDetail(details, payrollId, itemIdMap,
                        PayrollDetailDto.builder()
                                .itemCode("WEEKLY_ALLOWANCE")
                                .amount(weeklyAllowanceAmount)
                                .memo("주휴수당")
                                .build());

        if (overtimePremium > 0) payrollFunctions
                .addDetail(details, payrollId, itemIdMap,
                        PayrollDetailDto.builder()
                                .itemCode("OVERTIME_PREMIUM")
                                .amount(overtimePremium)
                                .minutes(totalOvertimeMinutes)
                                .unitPrice(hourlyRate)
                                .multiplier(overtimeMultiplier)
                                .memo("연장 프리미엄")
                                .build());

        if (nightPremium > 0) payrollFunctions
                .addDetail(details, payrollId, itemIdMap,
                        PayrollDetailDto.builder()
                                .itemCode("NIGHT_PREMIUM")
                                .amount(nightPremium)
                                .minutes(totalNightMinutes)
                                .unitPrice(hourlyRate)
                                .multiplier(nightMultiplier)
                                .memo("야간 프리미엄")
                                .build());

        if (incomeTax > 0) payrollFunctions
                .addDetail(details, payrollId, itemIdMap,
                        PayrollDetailDto.builder()
                                .itemCode("INCOME_TAX")
                                .amount(incomeTax)
                                .memo("소득세")
                                .build());

        if (localTax > 0) payrollFunctions
                .addDetail(details, payrollId, itemIdMap,
                        PayrollDetailDto.builder()
                                .itemCode("LOCAL_TAX")
                                .amount(localTax)
                                .memo("지방소득세")
                                .build());

        if (nationalPension > 0) payrollFunctions
                .addDetail(details, payrollId, itemIdMap,
                        PayrollDetailDto.builder()
                                .itemCode("NATIONAL_PENSION")
                                .amount(nationalPension)
                                .memo("국민연금(근로자)")
                                .build());

        if (healthInsurance > 0) payrollFunctions
                .addDetail(details, payrollId, itemIdMap,
                        PayrollDetailDto.builder()
                                .itemCode("HEALTH_INSURANCE")
                                .amount(healthInsurance)
                                .memo("건강보험(근로자)")
                                .build());

        if (employmentInsurance > 0) payrollFunctions
                .addDetail(details, payrollId, itemIdMap,
                        PayrollDetailDto.builder()
                                .itemCode("EMPLOYMENT_INSURANCE")
                                .amount(employmentInsurance)
                                .memo("고용보험(근로자)")
                                .build());

        if (!details.isEmpty()) {
            payrollMapper.insertPayrollDetails(details);
        }

        return payrollId;
    }

}


==================================================
FILE: src/main/java/com/korit/sa_one_back/service/StoreApplicationService.java
==================================================

package com.korit.sa_one_back.service;

import com.korit.sa_one_back.dto.request.StoreApplicationReqDto;
import com.korit.sa_one_back.dto.response.MyStoreRespDto;
import com.korit.sa_one_back.entity.StoreApplicationEntity;
import com.korit.sa_one_back.entity.StoreEntity;
import com.korit.sa_one_back.exception.StoreApplicationException;
import com.korit.sa_one_back.mapper.StoreMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class StoreApplicationService {
    private final StoreMapper storeMapper;

    // 유저용
    public void postMyApplication(StoreApplicationReqDto dto, Long userId) {
        StoreApplicationEntity storeApplicationEntity = dto.toStoreApplicationEntity(userId);

        storeMapper.insertStoreApplication(storeApplicationEntity);
    }

    public StoreApplicationEntity getMyApplication (Long userId) {
        StoreApplicationEntity storeApplication = storeMapper.selectByUserId(userId);

        if (storeApplication == null) {
            throw new StoreApplicationException();
        }

        return storeApplication;
    }

    public List<MyStoreRespDto> getMyStores(Long userId) {
        return storeMapper.findMyStoresByUserId(userId)
                .stream()
                .map(MyStoreRespDto::fromEntity)
                .collect(Collectors.toList());
    }

    // 어드민용
    @Transactional
    public void createStoreInformation(StoreApplicationReqDto dto) throws IllegalAccessException {
        StoreApplicationEntity storeApplication = storeMapper.selectByApplicationIdForAdmin(dto.getStoreApplicationId());

        if (storeApplication == null) {
            throw new IllegalAccessException("요청하신 신청 정보를 찾을 수 없습니다.");
        }

        if (!"PENDING".equalsIgnoreCase(storeApplication.getStatus())) {
            throw new IllegalAccessException("이미 처리된 신청입니다.");
        }

        storeMapper.insertStore(dto.toStoreEntity());

        storeMapper.updateApplicationStatus(dto.getStoreApplicationId(), "APPROVED", LocalDateTime.now(), null);
    }

    public void rejectApplication(Long storeApplicationId, String rejectReason) throws IllegalAccessException {
        StoreApplicationEntity storeApplication = storeMapper.selectByApplicationIdForAdmin(storeApplicationId);

        if (storeApplication == null) {
            throw new IllegalAccessException("요청하신 신청 정보를 찾을 수 없습니다.");
        }

        if (!"REJECTED".equalsIgnoreCase(storeApplication.getStatus())) {
            throw new IllegalAccessException("이미 처리된 신청입니다.");
        }

        storeMapper.updateApplicationStatus(storeApplicationId, "REJECTED", LocalDateTime.now(), rejectReason);
    }
}


==================================================
FILE: src/main/java/com/korit/sa_one_back/service/UserService.java
==================================================

package com.korit.sa_one_back.service;

import com.korit.sa_one_back.dto.request.*;
import com.korit.sa_one_back.dto.response.UserMeRespDto;
import com.korit.sa_one_back.entity.UserEntity;
import com.korit.sa_one_back.jwt.JwtTokenProvider;
import com.korit.sa_one_back.mapper.MyPageMapper;
import com.korit.sa_one_back.mapper.UserMapper;
import com.korit.sa_one_back.security.PrincipalUser;
import lombok.RequiredArgsConstructor;
import org.springframework.security.authentication.BadCredentialsException;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.oauth2.client.userinfo.DefaultOAuth2UserService;
import org.springframework.security.oauth2.client.userinfo.OAuth2UserRequest;
import org.springframework.security.oauth2.core.OAuth2AuthenticationException;
import org.springframework.security.oauth2.core.user.OAuth2User;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.UUID;


@Service
@RequiredArgsConstructor
public class UserService extends DefaultOAuth2UserService {

    private final UserMapper userMapper;
    private final JwtTokenProvider jwtTokenProvider;
    private final BCryptPasswordEncoder passwordEncoder;
    private final MyPageMapper myPageMapper;
    private final MailService mailService;

    // Local 회원 생성
    public void createLocalUser(SignUpReqDto dto) {
        UserEntity user = dto.toLocalEntity(passwordEncoder);
        userMapper.insertLocalUser(user);
    }

    // OAuth2 회원 생성
    public void createOauth2User(OAuth2SignUpReqDto dto) {
        String password = UUID.randomUUID().toString();
        String encodedPassword = passwordEncoder.encode(password);
        UserEntity user = dto.toOauth2Entity(encodedPassword);
        userMapper.insertOauth2User(user);
    }

    public String signin(SignInReqDto dto) {
        final String username = dto.getUsername();
        final String password = dto.getPassword();
        final String defaultMessage = "사용자 정보를 확인하세요.";

        UserEntity foundUser = userMapper.findUserByUsername(username);
        if (foundUser == null) {
            throw new UsernameNotFoundException(defaultMessage);
        }
        if (!passwordEncoder.matches(password, foundUser.getPassword())) {
            throw new BadCredentialsException(defaultMessage);
        }
        // 토큰 생성
        final String accessToken = jwtTokenProvider.createToken(foundUser);

        return accessToken;
    }

    public void delete(long userId) throws IllegalAccessException {
        UserEntity user = userMapper.findByUserId(userId);

        if (user == null || user.isDeleted()) {
            throw new IllegalAccessException("이미 탈퇴한 사용자 입니다.");
        }

        userMapper.softDelete(userId);
    }

    /**
     * 마이페이지 정보 조회 (사장 / 직원 공통)
     * 1) userId로 user_tb 조회 (공통 정보)
     * 2) role_tb join해서 role_name 조회
     * 3) role에 따라 필요한 정보만 추가 조회
     * - EMPLOYEE → employeeInfo
     * - OWNER / MANAGER → ownerInfo (매장 목록 + 선택 매장)
     * 4) 하나의 Response DTO로 조립해서 반환
     */
    public UserMeRespDto getMyPage(Long userId, Long storeId) {

        // 공통 유저 정보
        UserEntity user = userMapper.findByUserId(userId);

        // role 이름 (OWNER / MANAGER / EMPLOYEE)
        String roleName = userMapper.findRoleNameByUserId(userId);

        // role별 추가 정보 (기본 null)
        UserMeRespDto.EmployeeInfo employeeInfo = null;
        UserMeRespDto.OwnerInfo ownerInfo = null;

        // 직원인 경우
        if ("EMPLOYEE".equals(roleName)) {
            employeeInfo = myPageMapper.findEmployeeInfoByUserId(userId);

            // 사장 / 매니저인 경우
        } else if ("OWNER".equals(roleName) || "MANAGER".equals(roleName)) {

            // (1) 내 사업장 목록
            List<UserMeRespDto.StoreInfo> storeList =
                    myPageMapper.findMyStoreList(userId);

            // (2) 선택된 storeId 결정
            // - 프론트에서 storeId 안 주면 첫 번째 매장 자동 선택
            Long resolvedStoreId = storeId;
            if (resolvedStoreId == null) {
                resolvedStoreId = myPageMapper.findFirstStoreId(userId);
            }

            // (3) 선택된 사업장 상세
            UserMeRespDto.StoreInfo selectedStore = null;
            if (resolvedStoreId != null) {
                selectedStore =
                        myPageMapper.findMyStoreDetail(userId, resolvedStoreId);
            }

            ownerInfo = UserMeRespDto.OwnerInfo.builder()
                    .storeList(storeList)
                    .selectedStore(selectedStore)
                    .build();
        }

        // 최종 응답 DTO 조립
        return UserMeRespDto.builder()
                .userId(user.getUserId())
                .role(roleName)
                .username(user.getUsername())

                .email(user.getEmail())
                .phone(user.getPhone())
                .imgUrl(user.getImgUrl())

                .name(user.getName())
                .gender(user.getGender())
                .birthDate(user.getBirthDate())

                .employeeInfo(employeeInfo)
                .ownerInfo(ownerInfo)
                .build();
    }

    /**
     * ✅ 마이페이지 수정

     * 1) 로그인 userId를 서버에서 확정한다 (프론트가 바꾸게 두면 안 됨)
     * 2) PATCH이므로 넘어온 값만 Entity에 담는다
     * 3) mapper update 실행
     * 4) 반영된 row가 0이면 예외(유저 없음 등)
     */
    public void updateMyPage(Long userId, UpdateMyPageReqDto dto) {

        UserEntity user = new UserEntity();
        user.setUserId(userId);

        // PATCH: null/빈문자면 수정하지 않도록 mapper에서 if 처리함
        user.setEmail(dto.getEmail());
        user.setPhone(dto.getPhone());
        user.setImgUrl(dto.getImgUrl());

        int result = userMapper.updateMyPage(user);

        if (result == 0) {
            throw new RuntimeException("회원 정보 수정에 실패했습니다.");
        }
    }

    public void findUsernameAndSendMail(FindUsernameReqDto dto) {
        String username = userMapper.findUsernameByNameAndEmail(dto.getName(), dto.getEmail());

        if (username == null || username.isBlank()) return;

        String masked = maskingUsername(username);
        mailService.sendMarkedUsername(dto.getEmail(), masked);
    }

    private String maskingUsername(String username) {
        int n = username.length();
        if (n <= 1) return "*";
        if (n == 2) return username.charAt(0) + "*";
        if (n <= 4) return username.substring(0, 1) + "**" + username.substring(n - 1);
        return username.substring(0,2) + "***" + username.substring(n - 2);
    }
}



==================================================
FILE: src/main/resources/application-secret.yml
==================================================

spring:
  config:
    activate:
      on-profile: secret
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://34.11.250.12:3306/saone_project_db
    username: root
    password: d#a21@!!kuen^^7f)eaccp2(
  security:
    oauth2:
      client:
        registration:
          naver:
            client-id: HXtdmFrYcIVf4L6ad7Vl
            client-secret: RLB6pE0go0
            redirect-uri: http://localhost:8080/login/oauth2/code/naver
            authorization-grant-type: authorization_code
            client-name: NAVER
        provider:
          naver:
            authorization-uri: https://nid.naver.com/oauth2.0/authorize
            token-uri: https://nid.naver.com/oauth2.0/token
            user-info-uri: https://openapi.naver.com/v1/nid/me
            user-name-attribute: response
  mail:
    host: smtp.gmail.com
    port: 587
    username: dongwan03224@gmail.com
    password: jxzpgwqmswklzupt
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true

jwt:
  secret: f01a781c5b05d34a908562b13436d0c9a8a9e77ff6827b99801ce6206489b6e5bdafa888e6a166c835bba7909914f1a74b895838e3b8a6c636ce258faff7cf51



==================================================
FILE: src/main/resources/application.yml
==================================================

spring:
  profiles:
    active: local
    group:
      local: common, secret

---

spring:
  config:
    activate:
      on-profile: common
  servlet:
    multipart:
      max-file-size: 10MB    # 파일 하나당 크기
      max-request-size: 100MB    # 요청 전체 크기
  data:
    redis:
      host: localhost
      port: 6379

server:
  tomcat:
    max-swallow-size: -1  # 스프링 부트가 주는걸 다 기다리겠다

app:
  base-url: "http://localhost:8080"

springdoc:
  swagger-ui:
    path: doc

mybatis:
  mapper-locations: classpath:mapper/**/*.xml
  configuration:
    map-underscore-to-camel-case: true
  type-aliases-package: com.korit.sa_one_back.entity

==================================================
FILE: src/main/resources/mapper/admin/admin_mapper.xml
==================================================

<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.korit.sa_one_back.mapper.admin.AdminDashboardMapper">

    <select id="countStoreApplicationsByStatus" resultType="java.lang.Integer">
        select count
            (*)
        from
            store_application_tb
        where
            status = 'PENDING'
    </select>
    <select id="existMinimumWage" resultType="java.lang.Integer">
        select exists(
            select
                1
            from
                minimum_wage_tb
            where
                year = #{year}
        )
    </select>
    <select id="existTaxRate" resultType="java.lang.Integer">
        select exists(
            select
                1
            from
                tax_rate_tb
            where
                year = #{year}
        )
    </select>
    <select id="existInsuranceRate" resultType="java.lang.Integer">
        select exists(
            select
                1
            from
                insurance_rate_tb
            where
                year = #{year}
        )
    </select>
    <select id="existNationalPensionRateLimit" resultType="java.lang.Integer">
        select exists(
            select
                1
            from
                national_pension_limit_tb
            where
                year = #{year}
        )
    </select>
    <select id="existHealthInsuranceRateLimit" resultType="java.lang.Integer">
        select exists(
            select
                1
            from
                health_insurance_limit_tb
            where
                year = #{year}
        )
    </select>
    <select id="existEmploymentCompanyRate" resultType="java.lang.Integer">
        select exists(
            select
                1
            from
                employment_company_rate_tb
            where
                year = #{year}
        )
    </select>
    <select id="existIndustrialAccidentRate" resultType="java.lang.Integer">
        select exists(
            select
                1
            from
                industrial_accident_rate_tb
            where
                year = #{year}
        )
    </select>
</mapper>

==================================================
FILE: src/main/resources/mapper/employee_mapper.xml
==================================================

<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.korit.sa_one_back.mapper.EmployeeMapper">

    <!-- ✅ storeId + userId가 ACTIVE 상태로 이미 등록돼있는지 체크 -->
    <select id="existsActiveEmployee" resultType="boolean">
        select exists(
        select 1
        from store_employee_tb
        where store_id = #{storeId}
        and user_id = #{userId}
        and work_status = 'ACTIVE'
        )
    </select>

    <!-- ✅ 직원 소속(store_employee) 추가 -->
    <insert id="insertStoreEmployee" useGeneratedKeys="true" keyProperty="storeEmployeeId">
        insert into store_employee_tb (
        store_employee_id,
        store_id,
        user_id,
        employee_no,
        employee_name,
        position_id,
        join_date,
        work_status,
        updated_at
        ) values (
        default,
        #{storeId},
        #{userId},
        #{employeeNo},
        null,
        #{positionId},
        #{joinDate},
        #{workStatus},
        now()
        )
    </insert>

    <!-- ✅ 직원 목록 조회 (as 없음)
         ⚠️ XML에서 '<=' 같은 기호는 CDATA로 감싸야 안전함 -->
    <select id="selectEmployees" resultType="com.korit.sa_one_back.dto.response.EmployeeListRespDto">
        <![CDATA[
        select
            se.store_employee_id,
            se.store_id,
            se.user_id,
            se.employee_no,
            se.position_id,
            se.join_date,
            se.work_status,

            u.name,
            u.email,
            u.phone,
            u.img_url,
            u.img_path,
            u.birth_date,

            p.position_name,

            pay.pay_type,
            pay.hourly_rate,
            pay.monthly_salary,
            pay.start_date,
            pay.end_date
        from store_employee_tb se
        join user_tb u on u.user_id = se.user_id
        left join position_tb p on p.position_id = se.position_id
        left join pay_tb pay
            on pay.store_employee_id = se.store_employee_id
           and pay.start_date <= #{today}
           and (pay.end_date is null or pay.end_date >= #{today})
        where se.store_id = #{storeId}
          and se.work_status = 'ACTIVE'
        order by se.store_employee_id desc
        ]]>
    </select>

    <!-- ✅ 요청 ids가 해당 store 소속인지 검증 -->
    <select id="countBelonging" resultType="int">
        select count(*)
        from store_employee_tb
        where store_id = #{storeId}
        and store_employee_id in
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <!-- ✅ 퇴사 처리: work_status 변경 -->
    <update id="updateWorkStatus">
        update store_employee_tb
        set
        work_status = #{workStatus},
        updated_at = now()
        where store_employee_id = #{storeEmployeeId}
    </update>

</mapper>


==================================================
FILE: src/main/resources/mapper/mypage_mapper.xml
==================================================

<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.korit.sa_one_back.mapper.MyPageMapper">

    <!-- =========================================================
         [직원] 마이페이지 조회
         - 고용형태: pay_tb.pay_type
         ========================================================= -->
    <select id="findEmployeeInfoByUserId"
            resultType="com.korit.sa_one_back.dto.response.UserMeRespDto$EmployeeInfo">

        select
            se.store_employee_id,
            st.store_name,
            se.employee_no,
            se.join_date,
            se.work_status,
            p.pay_type,
            p.hourly_rate,
            p.monthly_salary
        from store_employee_tb se
        join store_tb st
            on st.store_id = se.store_id
        left join pay_tb p
            on p.store_employee_id = se.store_employee_id
        where se.user_id = #{userId}
        order by p.start_date desc
        limit 1

    </select>

    <!-- =========================================================
         [사장/매니저] 내 사업장 목록
         ========================================================= -->
    <select id="findMyStoreList"
            resultType="com.korit.sa_one_back.dto.response.UserMeRespDto$StoreInfo">

        select distinct
            st.store_id,
            st.store_name
        from store_employee_tb se
        join store_tb st on st.store_id = se.store_id
        where se.user_id = #{userId}
        order by st.store_id asc

    </select>

    <!-- 첫 번째 사업장 id -->
    <select id="findFirstStoreId" resultType="long">

        select
        st.store_id
        from store_employee_tb se
        join store_tb st on st.store_id = se.store_id
        where se.user_id = #{userId}
        order by st.store_id asc
        limit 1

    </select>

    <!-- =========================================================
         [사장/매니저] 선택된 사업장 상세
         ========================================================= -->
    <select id="findMyStoreDetail"
            resultType="com.korit.sa_one_back.dto.response.UserMeRespDto$StoreInfo">

        select
            st.store_id,
            st.store_name,
            st.business_number,
            st.store_phone,
            st.address,

            sbi.company_type,
            sbi.industry_code,

            it.industry_name

        from store_tb st
        join store_employee_tb se on se.store_id = st.store_id

        left join store_business_info_tb sbi on sbi.store_id = st.store_id
        left join industry_tb it on it.industry_code = sbi.industry_code

        where se.user_id = #{userId}
            and st.store_id = #{storeId}
        limit 1

    </select>

</mapper>


==================================================
FILE: src/main/resources/mapper/payroll_mapper.xml
==================================================

<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.korit.sa_one_back.mapper.PayrollMapper">

    <select id="findMonthlySummary" resultType="com.korit.sa_one_back.entity.payroll.MonthlyAttendanceSummaryEntity">
        select
            summary_id as summaryId,
            store_employee_id as storeEmployeeId,
            payslip_year_month as payslipYearMonth,
            work_days as workDays,
            total_work_minutes as totalWorkMinutes,
            total_overtime_minutes as totalOvertimeMinutes,
            total_night_minutes as totalNightMinutes,
            late_count as lateCount,
            early_leave_count as earlyLeaveCount,
            absent_count as absentCount,
            leave_days as leaveDays,
            created_at as createdAt
        from
            monthly_attendance_summary_tb
        where
            store_employee_id = #{storeEmployeeId}
            and
                payslip_year_month = #{payslipYearMonth}
        limit 1
    </select>

    <select id="findEffectivePay" resultType="com.korit.sa_one_back.entity.PayEntity">
        select
            pay_id as payId,
            store_employee_id as storeEmployeeId,
            pay_type as payType,
            hourly_rate as hourlyRate,
            monthly_salary as monthlySalary,
            start_date as startDate,
            end_date as endDate
        from
            pay_tb
        where
            store_employee_id = #{storeEmployeeId}
            and
                start_date &lt;= #{asOf}
            and
                (end_date is null or end_date &gt;= #{asOf})
        order by start_date desc
        limit 1
    </select>

    <select id="findEffectivePolicy" resultType="com.korit.sa_one_back.entity.payroll.PayPolicyEntity">
        select
            pay_policy_id as payPolicyId,
            store_id as storeId,
            effective_from as effectiveFrom,
            effective_to as effectiveTo,
            is_active as active,
            weekly_allowance_yn as weeklyAllowanceYn,
            overtime_multiplier as overtimeMultiplier,
            night_multiplier as nightMultiplier,
            created_at as createdAt,
            updated_at as updatedAt
        from
            pay_policy_tb
        where
            store_id = #{storeId}
            and
                effective_from &lt;= #{asOf}
            and
                (effective_to is null or effective_to &gt;= #{asOf})
            and
                is_active = 1
        order by effective_from desc
        limit 1
    </select>
    <select id="findTaxRate" resultType="com.korit.sa_one_back.entity.payroll.TaxRateEntity">
        select
            income_tax_rate as incomeTaxRate,
            local_tax_rate as localTaxRate
        from
            tax_rate_tb
        where
            year = #{year}
        limit 1
    </select>
    <select id="findNationalPensionLimit" resultType="com.korit.sa_one_back.entity.payroll.LimitEntity">
        select
            lower_limit as lowerLimit,
            upper_limit as upperLimit
        from
            national_pension_limit_tb
        where
            year = #{year}
        limit 1
    </select>
    <select id="findHealthInsuranceLimit" resultType="com.korit.sa_one_back.entity.payroll.LimitEntity">
        select
            lower_limit as lowerLimit,
            upper_limit as upperLimit
        from
            health_insurance_limit_tb
        where
            year = #{year}
        limit 1
    </select>
    <select id="findInsuranceRate" resultType="com.korit.sa_one_back.entity.payroll.InsuranceRateEntity">
        select
            ir.total_rate as totalRate,
            ir.employee_rate as employeeRate,
            ir.employer_rate as employerRate,
            i.insurance_name as insuranceName
        from
            insurance_rate_tb as ir
        join
            insurance_tb as i
            on i.insurance_id = ir.insurance_id
        where
            ir.year = #{year}
            and
                i.insurance_code = #{insuranceCode}
        limit 1
    </select>
    <select id="findStoreBusinessInfo"
            resultType="com.korit.sa_one_back.entity.payroll.StoreBusinessInfoEntity">
        select
            store_business_info_id as storeBusinessInfoId,
            store_id as storeId,
            company_type as companyType,
            industry_code as industryCode,
            business_number as businessNumber,
            company_name as companyName,
            created_at as createdAt,
            updated_at as updatedAt
        from
            store_business_info_tb
        where
            store_id = #{storeId}
        limit 1
    </select>
    <select id="sumWeeklyAllowanceAmountInMonth" resultType="java.lang.Integer">
        select
            coalesce(sum(wa.allowance_amount),0)
        from
            weekly_allowance_tb as wa
        where
            wa.store_employee_id = #{storeEmployeeId}
            and
                wa.is_eligible = 1
            and
                wa.week_start_date &lt;= #{monthEnd}
            and
                wa.week_end_date &gt;= #{monthStart}
    </select>
    <select id="findPayrollItemIdByCode" resultType="java.lang.Long">
        select
            payroll_item_id
        from
            payroll_item_tb
        where
            item_code = #{itemCode}
        limit 1
    </select>
    <select id="findPayrollByYm" resultType="com.korit.sa_one_back.entity.payroll.PayrollEntity">
        select
            payroll_id as payrollId,
            store_employee_id as storeEmployeeId,
            payslip_year_month as payslipYearMonth,
            period_start as periodStart,
            period_end as periodEnd,
            pay_date as payDate,
            status as status,
            issued_at as issuedAt,
            confirmed_at as confirmedAt,

            weekly_allowance_yn as weeklyAllowanceYn,
            overtime_multiplier as overtimeMultiplier,
            night_multiplier as nightMultiplier,

            total_work_minutes as totalWorkMinutes,
            total_overtime_minutes as totalOvertimeMinutes,
            total_night_minutes as totalNightMinutes,

            gross_pay as grossPay,
            total_deduction as totalDeduction,
            net_pay as netPay,

            income_tax_rate as incomeTaxRate,
            local_tax_rate as localTaxRate,
            national_pension_rate as nationalPensionRate,
            health_insurance_rate as healthInsuranceRate,
            employment_insurance_rate as employmentInsuranceRate,

            industrial_accident_insurance as industrialAccidentInsurance,

            created_at as createdAt,
            updated_at as updatedAt
        from
            payroll_tb
        where
            store_employee_id = #{storeEmployeeId}
            and
                payslip_year_month = #{payslipYearMonth}
        limit 1
    </select>

    <insert id="insertPayroll" useGeneratedKeys="true" keyProperty="payrollId">
        insert into payroll_tb (
            store_employee_id,
            payslip_year_month,
            period_start,
            period_end,
            pay_date,
            status,
            issued_at,
            confirmed_at,
            weekly_allowance_yn,
            overtime_multiplier,
            night_multiplier,
            total_work_minutes,
            total_overtime_minutes,
            total_night_minutes,
            gross_pay,
            total_deduction,
            net_pay,
            income_tax_rate,
            local_tax_rate,
            national_pension_rate,
            health_insurance_rate,
            employment_insurance_rate,
            industrial_accident_insurance,
            created_at,
            updated_at
        ) values (
            #{storeEmployeeId},
            #{payslipYearMonth},
            #{periodStart},
            #{periodEnd},
            #{payDate},
            #{status},
            #{issuedAt},
            #{confirmedAt},
            #{weeklyAllowanceYn},
            #{overtimeMultiplier},
            #{nightMultiplier},
            #{totalWorkMinutes},
            #{totalOvertimeMinutes},
            #{totalNightMinutes},
            #{grossPay},
            #{totalDeduction},
            #{netPay},
            #{incomeTaxRate},
            #{localTaxRate},
            #{nationalPensionRate},
            #{healthInsuranceRate},
            #{employmentInsuranceRate},
            #{industrialAccidentInsurance},
            now(),
            now()
        )
    </insert>
    <insert id="insertPayrollDetails" parameterType="java.util.List">
        insert into payroll_detail_tb (
            payroll_id,
            payroll_item_id,
            amount,
            minutes,
            quantity,
            unit_price,
            multiplier,
            memo,
            updated_at
        )
        values
        <foreach collection="list" item="d" separator=",">
            (
                #{d.payrollId},
                #{d.payrollItemId},
                #{d.amount},
                #{d.minutes},
                #{d.quantity},
                #{d.unitPrice},
                #{d.multiplier},
                #{d.memo},
                now()
            )
        </foreach>
    </insert>
    <select id="findStoreEmployeePayrollByUserIdAndStoreId" resultType="com.korit.sa_one_back.entity.payroll.PayrollEntity">
        select
            store_employee_id
        from
            store_employee_tb
        where
            user_id = #{userId}
            and
                store_id = #{storeId}
        limit 1
    </select>

    <select id="findPayrollDetailsByPayrollId" resultType="com.korit.sa_one_back.entity.payroll.PayrollDetailEntity">
        select
            payroll_detail_id as payrollDetailId,
            payroll_id as payrollId,
            payroll_item_id as payrollItemId,
            amount,
            minutes,
            quantity,
            unit_price as unitPrice,
            multiplier,
            memo,
            updated_at as updatedAt
        from
            payroll_detail_tb
        where
            payroll_id = #{payrollId}
        order by payroll_detail_id asc
    </select>

    <select id="findPayrollItemCodeIdList" resultType="map">
        select
            item_code as itemCode,
            payroll_item_id as payrollItemId
        from
            payroll_item_tb
    </select>
</mapper>

==================================================
FILE: src/main/resources/mapper/pay_mapper.xml
==================================================

<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.korit.sa_one_back.mapper.PayMapper">

    <insert id="insertPay" useGeneratedKeys="true" keyProperty="payId">
        insert into pay_tb (
            pay_id,
            store_employee_id,
            pay_type,
            hourly_rate,
            monthly_salary,
            start_date,
            end_date,
            created_at,
            updated_at
        ) values (
            default,
            #{storeEmployeeId},
            #{payType},
            #{hourlyRate},
            #{monthlySalary},
            #{startDate},
            #{endDate},
            now(),
            now()
        )
    </insert>

    <!-- 퇴사 처리 시 현재 유효 급여 종료 -->
    <update id="closeCurrentPayByEmployee">
        update pay_tb
        set
        end_date = #{today},
        updated_at = now()
        where store_employee_id = #{storeEmployeeId}
        and not (start_date > #{today})
        and (end_date is null or end_date >= #{today})
    </update>


</mapper>


==================================================
FILE: src/main/resources/mapper/position_mapper.xml
==================================================

<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.korit.sa_one_back.mapper.PositionMapper">

    <select id="findPositionIdByName" resultType="long">
        select position_id
        from position_tb
        where position_name = #{positionName}
        limit 1
    </select>

</mapper>

==================================================
FILE: src/main/resources/mapper/store_mapper.xml
==================================================

<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.korit.sa_one_back.mapper.StoreMapper">

    <insert id="insertStore" useGeneratedKeys="true" keyProperty="storeId">
        insert into store_tb (
            store_id,
            store_name,
            address,
            business_number,
            owner_name,
            store_phone,
            created_at,
            updated_at,
            user_id
        )
        values(
            default,
            #{storeName},
            #{address},
            #{businessNumber},
            #{ownerName},
            #{storePhone},
            now(),
            now(),
            #{userId}
        )
    </insert>
  
    <insert id="insertStoreApplication">
        insert into store_application_tb (
            store_application_id,
            store_name,
            address,
            business_number,
            owner_name,
            store_phone,
            status,
            reject_reason,
            reviewed_at,
            created_at,
            user_id
        ) values (
            default,
            #{storeName},
            #{address},
            #{businessNumber},
            #{ownerName},
            #{storePhone},
            default,
            null,
            null,
            now(),
            #{userId}
        )

    </insert>
  
    <update id="updateApplicationStatus">
        update
            store_application_tb
        set
            status = #{status},
            reviewed_at = #{reviewedAt},
            reject_reason = #{rejectReason},
            updated_at = now()
        where
            store_application_id = #{storeApplicationId}
    </update>
  
    <select id="selectByUserId" resultType="com.korit.sa_one_back.entity.StoreApplicationEntity">
        select
            *
        from
            store_application_tb
        where
            user_id = #{userId}
    </select>

    <select id="selectByApplicationIdForAdmin" resultType="com.korit.sa_one_back.entity.StoreApplicationEntity">
        select
            *
        from
            store_application_tb
        where
            store_application_id = #{storeApplicationId}
    </select>

    <select id="countByStoreId" resultType="int">
        select count(*)
        from store_tb
        where store_id = #{storeId}
    </select>

    <select id="findOwnerUserId" resultType="long">
        select user_id
        from store_tb
        where store_id = #{storeId}
        limit 1
    </select>

    <select id="findMyStoresByUserId" parameterType="long" resultType="com.korit.sa_one_back.entity.MyStoreEntity">
        select distinct
            s.store_id as storeId,
            s.store_name as storeName,
            s.address as address
        from
            store_employee_tb se
        join
            store_tb s
        on
            s.store_id = se.store_id
        where
            se.user_id = #{userId}
            and
                se.work_status = 'WORKING'
        order by s.store_id asc
    </select>

</mapper>


==================================================
FILE: src/main/resources/mapper/user_mapper.xml
==================================================

<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.korit.sa_one_back.mapper.UserMapper">

    <insert id="insertLocalUser" useGeneratedKeys="true" keyProperty="userId">
        insert into user_tb(
            user_id,
            username,
            password,
            oauth2_id,
            provider,
            name,
            phone,
            email,
            img_url,
            img_path,
            role_id,
            created_at,
            updated_at,
            gender,
            birth_date,
            is_deleted,
            address
        ) values (
            default,
            #{username},
            #{password},
            #{oauth2Id},
            #{provider},
            #{name},
            #{phone},
            #{email},
            #{imgUrl},
            #{imgPath},
            #{roleId},
            now(),
            now(),
            #{gender},
            #{birthDate},
            default,
            #{address}
        )
    </insert>
    <insert id="insertOauth2User" useGeneratedKeys="true" keyProperty="userId">
        insert into user_tb(
            user_id,
            username,
            password,
            oauth2_id,
            provider,
            name,
            phone,
            email,
            img_url,
            img_path,
            role_id,
            created_at,
            updated_at,
            gender,
            birth_date,
            is_deleted,
            address
        ) values (
            default,
            #{username},
            #{password},
            #{name},
            #{phone},
            #{email},
            #{imgUrl},
            #{imgPath},
            #{oauth2Id},
            #{provider},
            #{roleId},
            now(),
            now(),
            #{gender},
            #{birthDate},
            default,
            #{address}
        )
    </insert>

    <update id="softDelete">
        UPDATE
            user_tb
        SET
            is_deleted = TRUE,
            deleted_at = NOW()
        WHERE
            user_id = #{userId}
    </update>

    <select id="findByUserId" resultType="com.korit.sa_one_back.entity.UserEntity">
        select
            *
        from
            user_tb
        where
            user_id = #{userId}
        and
            is_deleted = false
    </select>

    <select id="findByEmail" resultType="com.korit.sa_one_back.entity.UserEntity">
        select
            *
        from
            user_tb
        where
            email = #{email}
        and
            is_deleted = false
    </select>

    <select id="findByOauth2IdAndProvider" resultType="com.korit.sa_one_back.entity.UserEntity">
        select
            *
        from
            user_tb
        where
            oauth2_id = #{oauth2Id}
        and
            provider = #{provider}
        and
            is_deleted = false
    </select>
    <select id="findUserByUsername" resultType="com.korit.sa_one_back.entity.UserEntity">
        select
            user_id,
            username,
            password,
            oauth2_id,
            provider,
            name,
            phone,
            email,
            img_url,
            img_path,
            role_id,
            created_at,
            updated_at,
            gender,
            birth_date,
            address
        from
            user_tb
        where
            username = #{username}
        and
            is_deleted = false
    </select>

    <select id="findRoleNameByUserId" resultType="string">
        select
            rt.role_name
        from
            user_tb ut
        join
            role_tb rt on rt.role_id = ut.role_id
        where
            ut.user_id = #{userId}
    </select>

    <update id="updateMyPage">
        update user_tb
        <set>
            <if test="email != null and email != ''">
                email = #{email},
            </if>
            <if test="phone != null and phone != ''">
                phone = #{phone},
            </if>
            <if test="imgUrl != null and imgUrl != ''">
                img_url = #{imgUrl},
            </if>
            <if test="dto.address != null and dto.address != ''">
                address = #{dto.address},
            </if>
        </set>
        where user_id = #{userId}
    </update>

    <select id="findUserIdByEmail" resultType="java.lang.Long">
        select
            user_id
        from
            user_tb
        where
            email = #{email}
        and
            is_deleted = false
        limit 1
    </select>

    <update id="updateEmployeeProfile">
        update user_tb
        <set>
            <if test="dto.name != null and dto.name != ''">
                name = #{dto.name},
            </if>
            <if test="dto.phone != null and dto.phone != ''">
                phone = #{dto.phone},
            </if>
            <if test="dto.imgUrl != null and dto.imgUrl != ''">
                img_url = #{dto.imgUrl},
            </if>
            <if test="dto.imgPath != null and dto.imgPath != ''">
                img_path = #{dto.imgPath},
            </if>
            <if test="dto.birthDate != null">
                birth_date = #{dto.birthDate},
            </if>
            <if test="dto.address != null and dto.address != ''">
                address = #{dto.address},
            </if>
        </set>
        where
            user_id = #{userId}
        and
            is_deleted = false
    </update>

    <select id="findUsernameByNameAndEmail" resultType="string">
        select
            username
        from
            user_tb
        where
            name = #{name}
        and
            email = #{email}
        and
            is_deleted = 0
        limit 1
    </select>

    <update id="updatePassword">
        update
            user_tb
        set
            password = #{password},
            updated_at = now()
        where
            user_id = #{userId}
        and
            is_deleted = false
    </update>

</mapper>

==================================================
FILE: src/test/java/com/korit/sa_one_back/SaOneBackApplicationTests.java
==================================================

package com.korit.sa_one_back;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class SaOneBackApplicationTests {

    @Test
    void contextLoads() {
    }

}
